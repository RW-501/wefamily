<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.2/purify.min.js"></script>


	
      <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

	
    <script src="../auth.js"></script>
    <script src="../firebase.js"></script>
    <title>Our Family</title>

	


<style>
#create-tree-section   .image-container{
border-radius:0;
}



	

	.add-spouse, .add-sibling{
    display: none !important;
	
	}
	#LRP{
    text-decoration: none;
    color: #858585;
    font-weight: 600;
    font-size: 1.5em;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    display: block;
    margin: 1%;
}
        .post-image-container {
width: 50px;
    height: 50px;
    border-radius: 5%;
    overflow: hidden;
    background-color: lightgray;
    display: inline-grid;
    justify-content: center;
    align-items: center;
    cursor: pointer;
        }
	
	.image-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            background-color: lightgray;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
		    margin: auto;
        }

        .uploaded-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input {
            display: none; /* Hide the file input */
        }

	
/* Styling for the message box */
.mainMessage-box {
  position: fixed;
  top: -100px; /* Initially hidden above the viewport */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
    color: #fff;
    font-weight: 800;
	width: 300px;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
  transition: top 0.5s ease-in-out;
  z-index: 1000;
}

.mainMessage-content {
  display: flex;
  flex-direction: column;
  align-items: center;
text-align: center;
}

#mainMessageText {
  margin: 10px 0;
    color: #fff;
}

/* Styling for the close button */
#mainCloseButton {
    background-color: #7b7978;
    color: #fff;
    border: none;
    border-radius: 3px;
    padding: 5px 10px;
    cursor: pointer;
    font-weight: 600;

}

#mainCloseButton:hover {
  background-color: #575453;
}


    /* Global styles */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }
*{
    box-sizing: border-box;
}
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        text-align: center;
        font-size: 36px;
        margin-bottom: 20px;
    }

    /* Styles for buttons */
    button {
    background-color: #8e9399;
    color: #fff;
    border: #5d5d5d solid;
    padding: 10px 20px;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
    border-radius: 10px;
    overflow: hidden;
    font-weight: 800;

    }

    button:hover {
        background-color: #4d4d4d;
    }



    label {
        font-weight: 700;
        margin-right: 10px;
    }

	


#tree-details
		    input[type="text"],
    input[type="date"],
    textarea {
       width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1.5em
    }
	
	
#post-content
	    input[type="text"],
    input[type="date"],
    textarea {
       width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1.5em
    }

	#tree-content{
min-height: 500px;
    overflow-y: auto;
    max-height: 1000px;
	}

	
    input[type="text"],
    input[type="date"],
    textarea {
       width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
    }
    /* Tree details section */
     #tree-details, #tree-content, #family_News, #member_Request  {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        margin: 20px 0;
    }
        #family-news-area, #family-members {
            max-height: 700px;
            resize: vertical;
            overflow-y: auto;
            position: relative;
            display: block;
        }
    #family-members {
        margin-top: 20px;
    }

    /* Pop-up styles */
    .popup-container {
        display: none;
        position: fixed;
     top: 0;
    left: 0;
    right: 0;
    bottom: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .popup {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        max-width: 90%;
        margin: auto;
            position: fixed;
        overflow-y: auto;
    bottom: 0;
    left: 0;
    right: 0;
    top: 0;
    width: fit-content;
            display: block;
            height: fit-content;
	        max-height: 90%;
    }

    .close-button {
text-align: end;
        font-size: 20px;
        cursor: pointer;
            display: block;
	        font-weight: 900;
    }

    /* Tree sections */
   
    .tree-section h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    /* Switch button styles */
    #join-create-button {
    /* background-color: #007BFF; */
    color: #fff;
    /* border: none; */
    /* padding: 10px 20px; */
    /* font-size: 16px; */
    cursor: pointer;
    /* border-radius: 4px; */
    transition: background-color 0.3s ease;
    }

    #join-create-button:hover {
        background-color: #0056b3;
    }
#search-family-tree input[type="text"], input[type="date"], textarea {  
    font-size: 1.5em;
}

	
    /* Search input and button styles */
    #family-tree-search,
    #family-tree-code {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #search-button,
    #enter-code-button {
  background-color: #007BFF; */
    color: #fff;
    /* border: none; */
    padding: 10px 20px;
    font-size: 16px;
    /* cursor: pointer; */
    /* border-radius: 4px; */
    transition: background-color 0.3s ease;
    }

    #search-button:hover,
    #enter-code-button:hover {
        background-color: #0056b3;
    }

    /* Add member modal styles */
    #add-member-modal {
        display: none;
    }

    #add-member-modal .popup {
        width: 400px;
    }

    #add-member-form label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    #add-member-form input[type="text"],
    #add-member-form input[type="date"],
    #add-member-form textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #add-member-form button {
         /* background-color: #007BFF; */
    color: #fff;
    /* border: none; */
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    /* border-radius: 4px; */
    transition: background-color 0.3s ease;
    }

    #add-member-form button:hover {
        background-color: #0056b3;
    }


.hidden {
    display: none;
}



.post .post-content {
    padding: 10px;
}

.post .image-container {
    margin-top: 10px; /* Add space below text content for image */
}

/* CSS for pinned posts */

#mainFamily-news-area {
    max-height: 700px;
    resize: vertical;
    position: relative;
    display: block;
    overflow: hidden;
    border-radius: 5px;
padding-top: 15px;
}
	
#pinnedFamily-news-area {
    max-height: 700px;
    resize: vertical;
    position: absolute;
    display: block;
    top: 0;
    width: 100%;
    z-index: 1;
}

	
.post {
    background-color: #ffffff;
    border: 1px solid #ccc;
    margin: 10px 0;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
}

.pin-post {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    outline: none;
    position: sticky; /* Use sticky position */
    top: 0; /* Stick to the top of the container */
    width: 100%;
    z-index: 1;
}

	.pin-post button {
            background-color: #fff;
		color: #007bff;
}
.pin_area{
	display:block;
	width: 400px;
}
	
.space_J {
    display: flex;
    justify-content: space-between;
	    width: 100%;

}
.flex {
display: flex;
    gap: 10px;

}


#family-tree {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
}

.family-member {
  text-align: center;
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px;
  border-radius: 5px;
  min-width: 150px;
  background-color: #f9f9f9;
  position: relative;
}

.member-details {
  margin-bottom: 10px;
}

.family-member button {
  display: none;
}

.family-member:hover button {
  display: inline-block;
}

/* Adjust styling as needed */

html, body{
    overflow: hidden;
    overflow-y: auto;
}
	
/* Navigation Bar styles */
.navbar {
    background-color: #333;
    color: #fff;
    padding: 10px 0;
}

.navbar .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.navbar a {
    color: #fff;
    text-decoration: none;
    margin-right: 20px;
}

.navbar .logo {
      font-size: 3em;
    font-weight: 800;
}

.navbar .nav-links {
    list-style: none;
    display: flex;
}

.navbar .nav-links li {
    margin-right: 10px;
}

.navbar .logout {
    background-color: #fff;
    color: #333;
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
}

.navbar .logout:hover {
    background-color: #555;
    color: #fff;
    transition: 0.3s;
}

/* Footer styles */
.footer {
    background-color: #333;
    color: #fff;
    text-align: center;
    padding: 10px 0;

    width: 100%;
}

/* Add this CSS in your stylesheet */
.navbar .dropdown-menu {
    display: none;
    background-color: #333;
    top: 100%;
    left: 0;
    width: 100%;
    z-index: 1;
}

.navbar .dropdown-menu ul {
    list-style: none;
    padding: 0;
}

.navbar .dropdown-menu ul li {
    padding: 10px;
    text-align: center;
}

.navbar .dropdown-menu ul li a {
    color: #fff;
    text-decoration: none;
    display: block;
}

/* Media query to show/hide the dropdown menu */
@media screen and (max-width: 900px) {
    .navbar .nav-links {
        display: none;
    }

    .navbar .dropdown-menu {
        display: block;
    }


}
	#family-tree, #family-tree-area{
    width: 100%;
    height: 800px;	
    overflow: auto;
}

	
	      .node {
            cursor: pointer;
        }
#postPic_img{
    border-radius: 10px;
    overflow: hidden;
 cursor: pointer;

}
.post_img{
width: 90% !important;
    object-fit: contain;
    margin: auto;
    display: block;
}
.post_img_Box{
width: 90% !important;
    cursor: pointer;
    display: block;
    margin: auto;
    height: 90%;
    padding: 2%;
    box-sizing: border-box;

}
#post_content{
    font-size: 2em;
    font-weight: 400;
	}
	.post_content{
    font-size: 2em;
    font-weight: 400;
font-size: 2em;
    font-weight: 400;
    padding: 2%;
    overflow-wrap: break-word;
	}
#meberDetailpopup{


.popup {
    display: flex;
}

.popup-left {
    display: flex;
    flex-direction: column;
}

.popup-image img {
    width: 100%; /* Ensure the image fills the container */
}

.popup-right {
    margin-left: 10px; /* Adjust spacing between the columns */
}

/* Media query for mobile view */
@media (max-width: 767px) {
    .popup {
        flex-direction: column; /* Switch to a single column layout for mobile */
    }
}
	
}
#meberDetailpopup{

}
#create-tree-section input[type="text"], input[type="date"], textarea { {

}

	
</style>
	    <script src="https://d3js.org/d3.v7.min.js"></script>

<script>
function initializeFamilyTreeChart() {
  const familyMembers = document.querySelectorAll('.family-member');

  familyMembers.forEach((member) => {
    const memberName = member.querySelector('.member-details');
    const buttons = member.querySelectorAll('button');

    memberName.addEventListener('click', () => {
      buttons.forEach((button) => {
        button.style.display = button.style.display === 'none' ? 'inline-block' : 'none';
      });
    });
  });
}



</script>
</head>
<body>
    <!-- Navigation Bar -->
   <nav class="navbar">
    <div class="container">
        <div class="logo">
            <a id="logo-link" href="/wefamily/dashboard/">WeFamily</a>
        </div>
        <div class="navbar-toggler">
            <div class="menu-icon">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </div>
        <ul class="nav-links">
            <li><a href="#tree-details">Tree Details</a></li>
            <li><a href="#tree-content">Family Members</a></li>
            <li><a href="#family-tree">Family Tree</a></li>
            <li><a href="#family-news">Family Chat</a></li>
            <li><a href="#member_request">Member Request</a></li>
            <li><a href="/wefamily/about/">About</a></li>
        </ul>
        <div class="user-actions">
            <button id="logout-button" onclick="logoutUser()">Logout</button>
        </div>
    </div>
    <div class="dropdown-menu">
        <ul>
            <li><a href="#tree-details">Tree Details</a></li>
            <li><a href="#tree-content">Family Members</a></li>
            <li><a href="#family-tree">Family Tree</a></li>
            <li><a href="#family-news">Family Chat</a></li>
            <li><a href="#member_request">Member Request</a></li>
            <li><a href="/wefamily/about/">About</a></li>
        </ul>
    </div>
</nav>




	
    <div class="container">
        <h1>Family Tree Management</h1>
        <div id="family-tree-container">
            <button onclick="openPopup()">Join / Create Family Tree</button>
            <div id="tree-details">
                <h2>Tree Details</h2>
                <label for="tree-name">Name:</label>
                <input type="text" id="tree-name" placeholder="Family Tree Name" required>
                <label for="tree-location">Location:</label>
                <input type="text" id="tree-location" placeholder="Location">
                <label for="tree-description">Description:</label>
                <textarea id="tree-description" placeholder="Brief Description"></textarea>
            </div>
            <div id="tree-content">
                <h2>Family Members</h2>
                <div id="family-members">
                    <!-- Family member details will be added here dynamically -->
                </div>
                <button id="add-member" onclick="showAddMemberModal()">Add Family Member</button>
            </div>


		
            <div id="family-tree">
              <div>  <h2>Family Tree</h2></div>
		    <div class="space_J" id="zoom-controls">
<div>
	<button id="export-button">Export as Image</button>
</div>
			   <div> 
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>
			   </div>
</div>

                <svg id="family-tree-area">
       
                </svg>
		    
            </div>

		
<div id="family-news">
    <h2>Family Chat</h2>
	
    <div id="mainFamily-news-area">
<div id="pinnedFamily-news-area"></div>
    <div id="family-news-area">
        <!-- Posts will be added here dynamically -->
    </div>
    </div>
	
    <textarea id="post-content" placeholder="Write your post..."></textarea>

			    <div class="space_J">
			    <div class="flex">
		 <!-- Image container with onclick event -->
    <div class="post-image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img id="postPic_img" class="uploaded-image" src="/wefamily/images/imgPlacehoder2.png" alt="Uploaded Image">
        <!-- File input element -->
        <input id="members_post_images" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
				   <div> <button onclick="addPost()">Add Post</button></div>
  </div>



	  <!-- Add a button to enable/disable the newsPost function -->
  <div clas="flex">  <button id="toggleNewsButton">System Posting</button>

	<button class="posts-buttons" onclick="loadFamilyPosts()">Member Posts</button>
	<button class="posts-buttons" onclick="loadPosts()">All Posts</button></div>
</div>
</div>



            
 <div id="member_Request">
                <h2>Family Member Request</h2>
                    <button class="memberRequest" onclick="openJoinRequestPopup()">View Member Request</button>

 </div>

</div>
    </div>
    
   <!-- Pop-up for creating a family tree -->
    <div class="popup-container" id="popup-container">
        <div class="popup">
            <span onclick="closePopup()" class="close-button">&times;</span>
            
<div id="create-tree-section" class="tree-section">
            <h2>Create a Family Tree</h2>
<p>
		 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img class="uploaded-image" src="/wefamily/images/imgPlacehoder.png" alt="Uploaded Image">
        <!-- File input element -->
        <input id="family_Tree_Image" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>

</p>
                <p>
                <label for="tree_name">Name:</label>
                <input type="text" id="tree_name" placeholder="Family Tree Name" required>
                    </p><p>
                <label for="tree_location">Location:</label>
                <input type="text" id="tree_location" placeholder="Location">
                </p>
                <label for="tree_public">Public:</label>
                 <input type="radio" id="tree_public" placeholder="public" checked>
                </p><p>
                <label for="tree_code">Code:</label>
                <input type="text" id="tree_code" placeholder="JoeFam411">
                </p><p>
                <label for="tree_description">Description:</label>
                <textarea id="tree_description" placeholder="Brief Description"></textarea>
                </p>
                <button onclick="createFamilyTree()">Create</button>
            </div>
<div id="join-tree-section" class="tree-section hidden">
            <h2>Join a Family Tree</h2><hr>
<div id="search-family-tree">
    <h2>Search for a Family Tree</h2>
    <input type="text" id="family-tree-search" placeholder="Enter Family Tree Name">
    <button id="search-button">Search</button>
</div>

<div id="enter-family-tree-code">
    <h2>Enter Family Tree Code</h2>
    <input type="text" id="family-tree-code" placeholder="Enter Code">
    <button id="enter-code-button">Enter</button>
</div>
 </div>
<div id="join-familytree-section" class="tree-section hidden">
    <h2>Join Request</h2>

            <label for="join_tree_name">Family Tree:</label>
    <div id="join_tree_name">tree name</div>
    
            <label for="join_tree_location">Locations:</label>
    <div id="join_tree_location">family locations</div>
<hr>
   <form id="join-request-form">
        <label for="request_first-name">First Name:</label>
        <input type="text" id="request_first-name" required><br><br>
        
        <label for="request_last-name">Last Name:</label>
        <input type="text" id="request_last-name" required><br><br>
        
        <label for="request_location">Location:</label>
        <input type="text" id="request_location" required><br><br>
        
        <label for="request_note">Note:</label>
        <textarea id="request_note"></textarea><br><br>
        
        <button type="button" onclick="joinRequestFunc()">Resquest To Join</button>
                <button  type="button" onclick="toggleJoinTree()">Back</button>
    </form>
    
</div>       
            <hr>
                    <button id="join-create-button" onclick="toggleTreeSections()">Join a family tree</button>

        </div>
    </div>

<div id="add-member-modal" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeAddMemberModal()">&times;</span>
        <h2>Add Family Member</h2>
        <form id="add-member-form">
            <p>
	 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img id="member_Image" class="uploaded-image" src="/wefamily/images/memberPlaceholder.jpg" alt="Uploaded Image">
        <!-- File input element -->
        <input id="member_main_Image" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
		    	    </p>
		<p>
            <label for="member-first_name">First Name:</label>
            <input type="text" id="member-first_name" required>
                </p><p>
<label for="member-last_name">Last Name:</label>
            <input type="text" id="member-last_name" required>
                </p><p>
            <label for="member-birthdate">Birthdate:</label>
            <input type="date" id="member-birthdate" required>
                    </p><p>
            <label for="member-private">Private:</label>
            <input type="checkbox" id="member-private">
                            </p><p>
            <label for="member-contact">Contact:</label>
            <input type="text" id="member-contact">
                                </p><p>
            <label for="member-note">Note:</label>
            <textarea id="member-note"></textarea>
                                </p>
            <button type="submit">Add Member</button>
        </form>
    </div>
</div>

<div id="join-request-popup" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeJoinRequestPopup()">&times;</span>
        <h2>Join Requests</h2>
        <ul id="join-request-list">
            <!-- Join requests will be added here dynamically -->
             <div>Loading</div>
        </ul>
    </div>
</div>
    <div class="mainMessage-box" id="mainMessageBox">
  <div class="mainMessage-content">
    <p id="mainMessageText">Your message here</p>
    <button id="mainCloseButton">Close</button>
  </div>
</div>

	<div id="add-member-type" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeAddMemberTypePopup()">&times;</span>
        <h2 id="memberType" >Add Family Member</h2>
        <form id="add-member-form">
<p>
	 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img class="uploaded-image" src="/wefamily/images/memberPlaceholder.jpg" alt="Uploaded Image">
        <!-- File input element -->
        <input id="newMember_main_Image" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
		
	</p>	
            <p>
            <label for="member-first_name_type">First Name:</label>
            <input type="text" id="member-first_name_type" required>
                </p><p>
<label for="member-last_name_type">Last Name:</label>
            <input type="text" id="member-last_name_type" required>
                </p><p>
            <label for="member-birthdate_type">Birthdate:</label>
            <input type="date" id="member-birthdate_type" required>
                    </p><p>           
	<label for="member-deceaseddate_type">Deceased Date:</label>
            <input type="date" id="member-deceaseddate_type" >
                    </p><p>
            <label for="member-note_type">Note:</label>
            <textarea id="member-note_type"></textarea>
                                </p>
            <button type="submit" id="memberTypeBTN">Add Member</button>
        </form>
    </div>
</div>

<div id="meberDetailpopup" class="popup-container">
    <div class="popup">
        <div class="popup-left">
            <div class="popup-image">
                <img id="member-image" src="" alt="Member Image">
            </div>
            <div class="popup-text">
                <textarea id="member-info" placeholder="Member Info"></textarea>
            </div>
        </div>
        <div class="popup-right">
            <ul id="member-details">
                <!-- Member details will be populated here -->
            </ul>
        </div>
    </div>
</div>

	
    <script>
var currentFamilyID = "";
var requestFamilyID = "";
// Add this JavaScript code in your script section



	    
//showMainMessage("message");
// Function to open the file input dialog when the image container is clicked
function openFileInput(container) {
    container.querySelector('.file-input').click();
}

// Function to handle file upload and display the selected image
function handleFileUpload(input) {
    const file = input.files[0];

    if (file) {
        // Check file type and size here (you can use the uploadImageToStorage function from earlier)
        // For simplicity, we'll just display the selected image
        const uploadedImage = input.previousElementSibling;
        uploadedImage.src = URL.createObjectURL(file);
    }
}

	    
// Reusable function to upload an image to Firebase Storage
function uploadImageToStorage(file, storagePath, successCallback, errorCallback) {
  // Check if a file was selected
  if (!file) {
    if (errorCallback) errorCallback('Please select an image file.');
    return;
  }

  // Check file type (allow only images)
  if (!file.type.startsWith('image/')) {
    if (errorCallback) errorCallback('Please select an image file (e.g., JPEG or PNG).');
    return;
  }

  // Check file size (limit to 5MB)
  if (file.size > 5 * 1024 * 1024) {
    if (errorCallback) errorCallback('Image size must be less than 5MB.');
    return;
  }

  // Create a reference to Firebase Storage
  const storageRef = firebase.storage().ref();

  // Generate a unique filename for the image
  const timestamp = Date.now();
  const filename = `${timestamp}_${file.name}`;

  // Create a reference to the storage location
  const imageRef = storageRef.child(`${storagePath}/${filename}`);

  // Resize the image to 500x500 pixels (using a library like HTMLCanvasElement)
  const img = new Image();
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  img.onload = () => {

	  
// Max width or height for the image
const maxSize = 500;

// Calculate new dimensions while maintaining aspect ratio
let newWidth, newHeight;
if (img.width > img.height) {
  newWidth = maxSize;
  newHeight = (img.height / img.width) * maxSize;
} else {
  newHeight = maxSize;
  newWidth = (img.width / img.height) * maxSize;
}


// Resize the image using canvas
canvas.width = newWidth;
canvas.height = newHeight;
ctx.drawImage(img, 0, 0, newWidth, newHeight);


    // Convert the resized image to a Blob
    canvas.toBlob((blob) => {
      // Upload the Blob to Firebase Storage
      const uploadTask = imageRef.put(blob);

      // Monitor the upload progress
      uploadTask.on(
        'state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log(`Upload progress: ${progress}%`);
        },
        (error) => {
          console.error('Upload error:', error);
          if (errorCallback) errorCallback('Image upload failed.');
        },
        () => {
          // Upload completed successfully, get the download URL
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            console.log('Image URL:', downloadURL);
            if (successCallback) successCallback(downloadURL);
          });
        }
      );
    }, 'image/jpeg', 0.9); // Convert to JPEG with 90% quality
  };

  // Load the selected image
  img.src = URL.createObjectURL(file);
}




	    
function deletePost(postID) {
    const postRef = firestore.collection('posts').doc(postID);
    document.getElementById('pinnedFamily-news-area').innerHTML = "";
    // Delete the post document
    return postRef
        .delete()
        .then(() => {
            console.log(`Post ${postID} deleted successfully.`);
        })
        .catch((error) => {
            console.error(`Error deleting post ${postID}:`, error);
        });
}
function updatePostPinnedStatus(postID, isPinned) {

    const postRef = firestore.collection('posts').doc(postID);
    document.getElementById('pinnedFamily-news-area').innerHTML = "";

    // Update the 'pinned' field of the post document
    return postRef.update({
        pinned: isPinned ? 'true' : '', // Use 'YES' for pinned, '' for unpinned
    })
    .then(() => {
        console.log(`Post ${postID} ${isPinned ? 'pinned' : 'unpinned'} successfully.`);
    })
    .catch((error) => {
        console.error(`Error updating post ${postID} pinned status:`, error);
    });
}



	    
const menuIcon = document.querySelector('.menu-icon');
const dropdownMenu = document.querySelector('.dropdown-menu');

menuIcon.addEventListener('click', () => {
    dropdownMenu.classList.toggle('active');
});

function loadFamilyPosts() {
    const familyNewsArea = document.getElementById('family-news-area');
    familyNewsArea.innerHTML = 'Loading...';

    // Listen for changes to the posts collection (Firestore query)
firestore.collection('posts')
    .where('treeID', '==', currentFamilyID)
    .where('postType', '!=', 'news')
    .orderBy('postType') // Use 'postType' as your first orderBy field
    .orderBy('timestamp', 'asc') // Then order by 'timestamp' in descending order
    .onSnapshot((querySnapshot) => {
        familyNewsArea.innerHTML = '';
        // Your code to handle the query results
    



            querySnapshot.forEach((doc) => {
                const post = doc.data();
                const postElement = document.createElement('div');
                postElement.classList.add('post');

const jsDate = post.timestamp ? new Date(post.timestamp.seconds * 1000 + (post.timestamp.nanoseconds || 0) / 1000000) : null;
                const options = { month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                const formattedDate = jsDate.toLocaleString('en-US', options);


               if (post.postType === 'news') {
    const postContent = `
        <p>${post.content}</p>
        <div class="space_J">
            <small>Posted by: ${post.author}</small>
            <small>Posted on: ${formattedDate}</small>
        </div>
    `;

    postElement.innerHTML = postContent;
} else if (post.postType === 'photo') {
    // Handle photo posts here
    const photoContent = `
        <div class="photo-post">
            <img src="${post.photoURL}" alt="Posted photo" />
            <p>${post.content}</p>
            <div class="space_J">
                <small>Posted by: ${post.author}</small>
                <small>Posted on: ${formattedDate}</small>
            </div>
        </div>
    `;

    postElement.innerHTML = photoContent;
} else {
    postElement.innerHTML = `
        <p>${post.content}</p>
        <div class="space_J">
            <small>Posted by: ${post.author}</small>
            <small>Posted on: ${formattedDate}</small>
        </div>
    `;
}

                familyNewsArea.appendChild(postElement);
	familyNewsArea.scrollTop = familyNewsArea.scrollHeight;

            });
        });

}


	    

function loadPosts() {
    const familyNewsArea = document.getElementById('family-news-area');
    familyNewsArea.innerHTML = 'Loading...';

    // Listen for changes to the posts collection (Firestore query)
    firestore.collection('posts')
        .where('treeID', '==', currentFamilyID) // Filter posts by treeID
        .orderBy('timestamp', 'asc') // Order by timestamp in ascending order
        .onSnapshot((querySnapshot) => {
            familyNewsArea.innerHTML = ''; // Clear the loading message

            querySnapshot.forEach((doc) => {
                const post = doc.data();
                const postElement = document.createElement('div');
                postElement.classList.add('post');
let isPinned = "";
if (post.pinned === 'true') {
	isPinned = true;
}else{
isPinned = false;
}

                const jsDate = post.timestamp ? new Date(post.timestamp.seconds * 1000 + (post.timestamp.nanoseconds || 0) / 1000000) : null;
                const options = { month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                const formattedDate = jsDate ? jsDate.toLocaleString('en-US', options) : '';

   const pinBTN = isPinned
                        ? `<button class='pin-button' onclick='updatePostPinnedStatus("${doc.id}", false)'>Unpin Post</button>`
                        : `<button class='pin-button' onclick='updatePostPinnedStatus("${doc.id}", true)'>Pin Post</button>`;


  // Replace URLs with clickable links
    const contentWithLinks = post.content.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank">$1</a>'
    );

		    
                if (post.postType === 'news') {
                    const postContent = `
            <p class="post_content">${contentWithLinks}</p>
                        <div class="space_J">
                            <small>Posted by: ${post.author}</small>
                            <small>Posted on: ${formattedDate}</small>
                        </div>
                    `;
                    postElement.innerHTML = postContent;
                } else if (post.postType === 'photo') {

			 // Add the "pin-post" class to pinned posts
                    if (isPinned) {
                        postElement.classList.add('pin-post');
                    }
    // Handle photo posts here
    const photoContent = `
    
        <div class="photo-post">
	                <div class="space_J">
                        <div class='pin_area'>${pinBTN}</div>
            <button class="delete-button" onclick="deletePost('${doc.id}')">Delete </button>
	    </div>
           <div class="post_img_Box"><img class="post_img" src="${post.photo}" alt="Posted photo" /></div>
            <p class="post_content">${contentWithLinks}</p>
            <div class="space_J">
                <small>Posted by: ${post.author}</small>
                <small>Posted on: ${formattedDate}</small>
            </div>
        </div>
    `;

    postElement.innerHTML = photoContent;
}else{		
                    // Add the "pin-post" class to pinned posts
                    if (isPinned) {
                        postElement.classList.add('pin-post');
                    }

                 
	    
                    postElement.innerHTML = `
		                            <div class="space_J">
                        <div class='pin_area'>${pinBTN}</div>
            <button class="delete-button" onclick="deletePost('${doc.id}')">Delete </button>
	    </div>

            <p class="post_content">${contentWithLinks}</p>
                        <div class="space_J">
                            <small>Posted by: ${post.author}</small>
                            <small>Posted on: ${formattedDate}</small>
                        </div>
                    `;
                }
                    if (isPinned) {
    document.getElementById('pinnedFamily-news-area').innerHTML = "";
document.getElementById('pinnedFamily-news-area').appendChild(postElement);
		    }else{
familyNewsArea.appendChild(postElement);
		    }
	
                familyNewsArea.scrollTop = familyNewsArea.scrollHeight;
            });
        });
}



function addPost() {
    const postContent = document.getElementById('post-content').value;
    const currentUser = auth.currentUser;
	
	
	if (!postContent || !currentUser) {
        return;
    }

    const post = {
	postID: "",
        postType: "text",
        pinned: "",
        treeID: currentFamilyID,
        userID: userID,
        content: postContent,
        photo: "",
        memberPhoto: Current_USERPHOTO,
        author: currentUser.displayName || Current_USERNAME || 'Anonymous',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    };


	
    firestore
        .collection("posts")
        .add(post)
        .then((docRef) => {
            console.log("News post added successfully with ID:", docRef.id);

            // Update the postID field with the generated document ID
            const update = { postID: docRef.id };
            firestore.collection("posts").doc(docRef.id).update(update);
		document.getElementById('post-content').value = '';
	    // Get the file input element
const selectedFile = document.getElementById('members_post_images').files[0]; 
					     // Get the selected file

if(!selectedFile){
         // Update the family tree document with the photo URL
                                firestore.collection('posts').doc(docRef.id).update({
                                    postID: docRef.id,
                                  

                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');

                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });
}else{
					     
                        const storagePath = 'members_post_images'; // Change the storage path as needed
                        uploadImageToStorage(
                            selectedFile,
                            storagePath,
                            (downloadURL) => {
                                console.log('Image uploaded successfully:', downloadURL);
                                // Handle success, e.g., save the downloadURL to your database

                                // Update the family tree document with the photo URL
                                firestore.collection('posts').doc(docRef.id).update({
                                    postID: docRef.id,
                                    photo: downloadURL,
				        postType: "photo",

                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');
    document.getElementById('postPic_img').src = "/wefamily/images/imgPlacehoder2.png";

                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });

			     })

	
			    
				}
		
        })
        .catch((error) => {
            console.error("Error adding news post:", error);
        });
	   
	      
	      }

	    
    let newsPostingEnabled = true;

        // Function to toggle the boolean flag
        function toggleNewsPosting() {
            newsPostingEnabled = !newsPostingEnabled;
            const buttonText = newsPostingEnabled ? 'Disable News Posting' : 'Enable News Posting';
            document.getElementById('toggleNewsButton').textContent = buttonText;
        }

        // Attach a click event listener to the button
        document.getElementById('toggleNewsButton').addEventListener('click', toggleNewsPosting);




function newsPost(xxx) {
    if (!xxx) {
        return;
    }
        if (!newsPostingEnabled) {
                console.log("News posting is currently disabled.");
                return;
            }
	
    const post = {
        postID: "", // Leave it empty for now
        postType: "news",
        pinned: "",
        treeID: currentFamilyID,
        userID: "",
        content: xxx,
        photo: "",
        memberPhoto: "",
        author: "Family Tree Update",
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    };

    firestore
        .collection("posts")
        .add(post)
        .then((docRef) => {
            console.log("News post added successfully with ID:", docRef.id);

            // Update the postID field with the generated document ID
            const update = { postID: docRef.id };
            firestore.collection("posts").doc(docRef.id).update(update);
        })
        .catch((error) => {
            console.error("Error adding news post:", error);
        });
}



        
function openJoinRequestPopup() {
    document.getElementById('join-request-popup').style.display = 'block';
    loadJoinRequests(); // Load join requests when the pop-up is opened
}

function closeJoinRequestPopup() {
    document.getElementById('join-request-popup').style.display = 'none';
}

function acceptJoinRequest(requestID, userID) {

	if(!requestID && !userID){
		return;
	}
	
    // Update the user's document to add the currentFamilyID to the userTrees array
    firestore.collection('users').doc(userID)
        .update({
            userTrees: firebase.firestore.FieldValue.arrayUnion(currentFamilyID)
        })
        .then(() => {
		
            // Get the document reference
            const requestRef = firestore.collection('memberRequest').doc(requestID);
            
            // Get the field data before deleting the document
            requestRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        const requestData = doc.data();
                        
                   
                        // Delete the document
                        requestRef.delete()
                            .then(() => {
                                console.log('Join request accepted and deleted.');
                                loadJoinRequests(); // Reload the list of join requests
				    
newsPost(`${requestData.first_name} ${requestData.last_name} added to the Family Tree`);

                                // Now you can use 'requestData' to access the field data of the deleted document
                                console.log('Field data of deleted document:', requestData);
                            })
                            .catch((error) => {
                                console.error('Error deleting join request:', error);
                            });
                    } else {
                        console.log('Document does not exist.');
                    }
                })
                .catch((error) => {
                    console.error('Error getting join request document:', error);
                });
        })
        .catch((error) => {
            console.error('Error updating user document:', error);
        });
}


function declineJoinRequest(requestID) {
    // Delete the join request from the memberRequest collection
    firestore.collection('memberRequest').doc(requestID).delete()
        .then(() => {
            console.log('Join request declined and deleted.');
            loadJoinRequests(); // Reload the list of join requests
        })
        .catch((error) => {
            console.error('Error deleting join request:', error);
        });
}



        
function loadJoinRequests() {
    // Get the join requests for the current family tree (currentFamilyID)
    firestore.collection('memberRequest').where('treeID', '==', currentFamilyID)
        .get()
        .then((querySnapshot) => {
            const joinRequestList = document.getElementById('join-request-list');
            joinRequestList.innerHTML = ''; // Clear the list

            if (querySnapshot.empty) {
                // If there are no join requests, display a message
                const message = document.createElement('p');
                message.textContent = 'No join requests found.';
                joinRequestList.appendChild(message);
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>${data.firstName} ${data.lastName}</span>
                        <button onclick="acceptJoinRequest('${doc.id}', '${data.userID}')">Accept</button>
                        <button onclick="declineJoinRequest('${doc.id}')">Decline</button>
                    `;
                    joinRequestList.appendChild(listItem);
                });
            }
        })
        .catch((error) => {
            console.error('Error loading join requests:', error);
        });
}






        
function joinRequestFunc() {
    // Get input values
    const firstName = document.getElementById('request_first-name').value;
    const lastName = document.getElementById('request_last-name').value;
    const location = document.getElementById('request_location').value;
    const note = document.getElementById('request_note').value;

    // Validate input data if needed

    // Create an object to represent the join request data
    const joinRequestData = {
        firstName: firstName,
        lastName: lastName,
        location: location,
        treeID: requestFamilyID,
        userID: userID,
        note: note,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),

        // Add more fields as needed
    };

    // Add the join request to the Firestore collection
    firestore.collection('memberRequest').add(joinRequestData)
        .then((docRef) => {
            console.log('Join request added with ID:', docRef.id);
            // You can perform further actions or provide feedback to the user
            // Clear form fields if needed
newsPost(`${joinRequestData.firstName} ${joinRequestData.lastName} request to join Family Tree`);

            document.getElementById('request_first-name').value = '';
            document.getElementById('request_last-name').value = '';
            document.getElementById('request_location').value = '';
            document.getElementById('request_note').value = '';
        })
        .catch((error) => {
            console.error('Error adding join request:', error);
        });
}



        
function toggleJoinTree() {
    const joinFamilytreeSection = document.getElementById("join-familytree-section");
    const joinTreeSection = document.getElementById("join-tree-section");

    // Check if the Create Tree section is currently visible
    if (joinFamilytreeSection.classList.contains("hidden")) {
        // Hide the Create Tree section
        joinTreeSection.classList.add("hidden");
        // Show the Join Tree section
        joinFamilytreeSection.classList.remove("hidden");
    } else {
        // Hide the Join Tree section
        joinFamilytreeSection.classList.add("hidden");
        // Show the Create Tree section
        joinTreeSection.classList.remove("hidden");
    }
}


        
// Function to search for family tree names
function searchFamilyTrees() {
    const searchInput = document.getElementById("family-tree-search").value;

    // Perform a Firestore query to search for family trees by name
    firestore.collection("familyTrees")
        .where("name", "==", searchInput)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                // No matching family trees found
                showMainMessage("No matching family trees found.");
            } else {
                // Display the matching family trees (you can decide how to display them)
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("Family Tree Name:", data.name);
                    console.log("Family Tree Location:", data.location);

                    requestFamilyID = data.treeID;
                    // Display more information as needed
    const join_tree_name = document.getElementById("join_tree_name");
    const join_tree_location = document.getElementById("join_tree_location");
 join_tree_name.innerHTML = data.name;                   
join_tree_location.innerHTML = data.location;

                });
                                    toggleJoinTree();

            }
        })
        .catch((error) => {
            console.error("Error searching for family trees:", error);
        });
}




        
// Function to get a family tree with the code
function getFamilyTreeWithCode() {
    const familyTreeCode = document.getElementById("family-tree-code").value;

    // Perform a Firestore query to get the family tree with the specified code
    firestore.collection("familyTrees")
        .where("familyCode", "==", familyTreeCode)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                // No family tree found with the specified code
                showMainMessage("No family tree found with the entered code.");
            } else {
                // Retrieve the family tree (assuming there is only one match)
                const familyTreeDoc = querySnapshot.docs[0];
                const familyTreeData = familyTreeDoc.data();
                    requestFamilyID = familyTreeData.treeID;

                // Use the family tree data as needed (e.g., display tree details)
                console.log("Family Tree Name:", familyTreeData.name);
                console.log("Family Tree Location:", familyTreeData.location);
                // Display more information as needed

   const join_tree_name = document.getElementById("join_tree_name");
    const join_tree_location = document.getElementById("join_tree_location");
 join_tree_name.innerHTML = familyTreeData.name;                   
join_tree_location.innerHTML = familyTreeData.location; 
                    toggleJoinTree();

    
            }
        })
        .catch((error) => {
            console.error("Error getting family tree with code:", error);
        });
}

// Add click event listeners to the search and enter code buttons
document.getElementById("search-button").addEventListener("click", searchFamilyTrees);
document.getElementById("enter-code-button").addEventListener("click", getFamilyTreeWithCode);

        // Function to toggle the visibility of Create Tree and Join Tree sections
function toggleTreeSections() {
    const createTreeSection = document.getElementById("create-tree-section");
    const joinTreeSection = document.getElementById("join-tree-section");
    const join_create_btn = document.getElementById("join-create-button");

    // Check if the Create Tree section is currently visible
    if (!createTreeSection.classList.contains("hidden")) {
        // Hide the Create Tree section
        createTreeSection.classList.add("hidden");
        // Show the Join Tree section
        joinTreeSection.classList.remove("hidden");
        join_create_btn.innerHTML= "Create Family Tree";
    } else {
        // Hide the Join Tree section
        joinTreeSection.classList.add("hidden");
        // Show the Create Tree section
        createTreeSection.classList.remove("hidden");
                join_create_btn.innerHTML= "Join Family Tree";

    }
}



// Function to display the add member modal
function showAddMemberModal() {
    const modal = document.getElementById('add-member-modal');
    modal.style.display = 'block';
}

// Function to close the add member modal
function closeAddMemberModal() {
    const modal = document.getElementById('add-member-modal');
    modal.style.display = 'none';
}

// Close the modal if the user clicks outside of it
window.onclick = function(event) {
    const modal = document.getElementById('add-member-modal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};

     // Function to open the pop-up
        function openPopup() {
            document.getElementById("popup-container").style.display = "flex";
        }

        // Function to close the pop-up
        function closePopup() {
            document.getElementById("popup-container").style.display = "none";
        }

			  
function createFamilyTree() {
    const treeName = document.getElementById("tree_name").value;
    const treeLocation = document.getElementById("tree_location").value;
    const treeDescription = document.getElementById("tree_description").value;
    const pubicBool = document.getElementById("tree_public").value;
    const familyCode = document.getElementById("tree_code").value;

    // Perform data validation
    if (!treeName || !treeLocation || !familyCode || !userID) {
        showMainMessage("Please fill in all required fields.");
        return;
    }

    // Check if a family tree with the same familyCode already exists
    firestore.collection('familyTrees').where('familyCode', '==', familyCode)
        .get()
        .then((querySnapshot) => {
            if (!querySnapshot.empty) {
                showMainMessage("A family tree with this family code already exists.");
            } else {
                // Create an object to represent the family tree data
                const familyTreeData = {
                    name: treeName,
                    location: [treeLocation],
                    description: treeDescription,
                    adminID: userID,
                    public: pubicBool,
                    familyCode: familyCode,
                    treeID: "",
                    root: "",
                    photo: "",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // Add more fields as needed
                };

                // Add the family tree to Firestore
                firestore.collection('familyTrees').add(familyTreeData)
                    .then((docRef) => {
                        console.log('Family tree added with ID:', docRef.id);
                        currentFamilyID = docRef.id;

                        // Reference to the user document in Firestore
                        const userDocRef = firestore.collection('users').doc(userID);

                        // Update the user document to add the family tree ID to the "userTrees" array field
                        userDocRef.update({
                            userTrees: firebase.firestore.FieldValue.arrayUnion(currentFamilyID),
                        })
                            .then(() => {
                                console.log('Family tree ID added to user document successfully.');
                                newsPost(`Admin ID ${familyTreeData.adminID} created ${familyTreeData.name} on ${familyTreeData.timestamp}`);
                            })
                            .catch((error) => {
                                console.error('Error adding family tree ID to user document:', error);
                            });


			    // Get the file input element
const selectedFile = document.getElementById('family_Tree_Image').files[0]; // Get the selected file
		if(!selectedFile){
          firestore.collection('familyTrees').doc(currentFamilyID).update({
                                    treeID: currentFamilyID,
                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');
	   const userDocRef = firestore.collection('users').doc(userID);
        const doc = await userDocRef.get();
const docData = doc.data();
    document.getElementById("member-first_name").value = docData.userName;
    document.getElementById("member-birthdate").value = docData.birthday;
    document.getElementById("member_Image").src = docData.photo;
  //  document.getElementById("member-first_name").value = docData.state;



	
                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });

                                closePopup();
                                showAddMemberModal();
		}else{
                        const storagePath = 'family_Tree_Image'; // Change the storage path as needed
                        uploadImageToStorage(
                            selectedFile,
                            storagePath,
                            (downloadURL) => {
                                console.log('Image uploaded successfully:', downloadURL);
                                // Handle success, e.g., save the downloadURL to your database
                                familyTreeData.photo = downloadURL; // Update the family tree data with the photo URL

                                // Update the family tree document with the photo URL
                                firestore.collection('familyTrees').doc(currentFamilyID).update({
                                    treeID: currentFamilyID,
                                    photo: downloadURL,
                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');

	    	   const userDocRef = firestore.collection('users').doc(userID);
        const doc = await userDocRef.get();
const docData = doc.data();
    document.getElementById("member-first_name").value = docData.userName;
    document.getElementById("member-birthdate").value = docData.birthday;
    document.getElementById("member_Image").src = docData.photo;
                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });

                                closePopup();
                                showAddMemberModal();
                            },
                            (error) => {
                                console.error('Image upload error:', error);
                                // Handle error, e.g., display an error message to the user
                            }
                        );
		}
                    })
                    .catch((error) => {
                        console.error('Error adding family tree:', error);
                    });
	    
            }
        })
        .catch((error) => {
            console.error('Error checking family code uniqueness:', error);
        });
}




          var treeData = '';

        

async function getFamilyTreeData(treeId) {
    try {

            // Ensure userID is defined and not empty
    if (!treeId) {
        

          return;
    }
        // Reference to the Firestore collection
        const familyTreesCollection = firestore.collection('familyTrees');

        // Query the collection for the specific treeId
        const querySnapshot = await familyTreesCollection.where('treeID', '==', treeId).get();

        // Check if a document matching the query exists
        if (querySnapshot.empty) {
            console.log('No matching documents.');
            return null;
        }

        // Retrieve the data from the first matching document (assuming treeId is unique)
        const familyTreeData = querySnapshot.docs[0].data();
	    		    treeData = familyTreeData;

                        console.log('new Family tree familyTreeData:', familyTreeData);

        return familyTreeData;
    } catch (error) {
        console.error('Error getting family tree:', error);
        return null;
    }
}






        
async function getFamilyTree(userID) {
    // Ensure userID is defined and not empty
    if (!userID) {
        // console.error('UserID is not defined or empty.');
        return;
    }

    // Reference to the user document in Firestore
    const userDocRef = firestore.collection('users').doc(userID);

    try {
        const doc = await userDocRef.get();

        if (doc.exists) {
            // Check if the user document has a "userTrees" field (an array of family tree IDs)
            if (doc.data().userTrees && doc.data().userTrees.length > 0) {
                // Get the first family tree ID from the user's array of family tree IDs
                const familyTreeId = doc.data().userTrees[0]; // You can modify this to get the desired family tree ID
                console.log('User has a family tree with ID:', familyTreeId);
		    
currentFamilyID = familyTreeId;

    
		    
                const tree = await getFamilyTreeData(familyTreeId);
                     displayTreeDetails(tree);
		    treeData = tree;
		            setTimeout(() => {
                loadFamilyTreeChart(treeData);
            }, 300); // Adj
			const treeID = tree.treeID;
			//currentFamilyID =treeID;
                    displayFamilyMembers(treeID);
                return;
            } else {
                document.getElementById("tree-details").style.display = "none";
                console.log('User does not have any family trees.');
                openPopup();
            }
        } else {
            console.log('User document does not exist.');
           window.location.href = '/wefamily';
        }
    } catch (error) {
        console.error('Error getting user document:', error);
    }
}


async function fetchFamilyTree() {
    try {
        const userID = await checkUserLogin();

        if (userID) {
// Get the logo link element by its ID
const logoLink = document.getElementById('logo-link');
// Set the href attribute dynamically with the userId
logoLink.href = `/wefamily/dashboard/?user=${userID}`;

	
            const treeId = getTreeIdFromQueryParams();

            if (treeId) {
                const tree = await getFamilyTreeData(treeId);

                if (tree) {
                   displayTreeDetails(tree);
			const treeID = tree.treeID;
			currentFamilyID = treeID;
                    displayFamilyMembers(treeID);

                } else {
                    console.log('Family tree not found.');
                    // Handle the case when the family tree is not found.
                            getFamilyTree(userID);
                }
            } else {
                console.log('Missing treeId parameter.');
                // Handle the case when the treeId query parameter is missing.
                            getFamilyTree(userID);
            }
        } else {
            // Redirect to the login page if the user is not logged in.
            console.log('checking user login:');

           window.location.href = '/wefamily';

        }
    } catch (error) {
        console.error('Error checking user login:', error);
        // Handle errors here, e.g., display an error message to the user.
    }
}


// JavaScript:


        // Function to add a new family member
// Function to add a family member
function addFamilyMember() {
	                    console.log('Added Member.');

    // Get input values
    const first_name = document.getElementById('member-first_name').value;
    const last_name = document.getElementById('member-last_name').value;
    const birthdate = document.getElementById('member-birthdate').value;
    const isPrivate = document.getElementById('member-private').checked;
    const contact = document.getElementById('member-contact').value;
    const note = document.getElementById('member-note').value;

if(!first_name && !last_name){
		return;
	}
    // You can perform data validation and error handling here

    // Create a new family member document and add it to the database
    const familyMember = {
        first_name: first_name,
        last_name: last_name,
        location: "",
        birthdate: birthdate,
        deceaseddate: "",
        photo: '',
        private: isPrivate,
        addByID: userID,
        familyID: [currentFamilyID], // Initialize familyID as an array with currentFamilyID
        userID: "",
        memberID: "",
        spouse: [],
        parents: [],
        sibling: [],
	    children: [],
        contact: contact,
        note: note,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),

        // Add other fields as needed
    };

// Add the family member to the 'familyMembers' collection
firestore.collection('familyMembers').add(familyMember)
    .then((docRef) => {
     
	    
const selectedFile = document.getElementById('member_main_Image').files[0]; // Get the selected file
		if(!selectedFile){
			const picURL = document.getElementById("member_Image").src;
  firestore.collection('familyMembers').doc(docRef.id).update({
                                    memberID: docRef.id,
                                    photo: picURL,
                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');
					   displayFamilyMembers(currentFamilyID);
					checkFirstMember(currentFamilyID,docRef.id);
                loadFamilyTreeChart(treeData);
document.getElementById("member_Image").src = "/images/memberPlaceholder.jpg";
                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });

		}else{
// Upload an image to gs://wefamily-44c0b.appspot.com/member_main_Image
uploadImageToStorage(
  selectedFile,
  'member_main_Image',
  (downloadURL) => {
    console.log('Image uploaded successfully to member_main_Image:', downloadURL);
    // Handle success, e.g., save the downloadURL to your database
   // Update the family tree document with the photo URL
                                firestore.collection('familyMembers').doc(docRef.id).update({
                                    photo: downloadURL,
                                    memberID: docRef.id,
                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');
					   displayFamilyMembers(currentFamilyID);
					checkFirstMember(currentFamilyID,docRef.id);
                loadFamilyTreeChart(treeData);

                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });
	  
  },
  (error) => {
    console.error('Image upload error:', error);
    // Handle error, e.g., display an error message to the user
  }	
);


		}
	    

  })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });
	  

    // Close the modal after adding the member
    closeAddMemberModal();
}








	  
document.getElementById('add-member-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent form submission
    addFamilyMember(); // Call the function to add the family member
});

function isFirstChild(currentFamilyID) {
    const db = firebase.firestore();
	                    console.log(' currentFamilyID.',currentFamilyID);

    // Query Firestore to count the documents
    return db.collection("familyMembers")
        .where('familyID', 'array-contains', currentFamilyID)
        .get()
        .then((querySnapshot) => {
            const count = querySnapshot.size; // Get the count of documents

            // Check if it's the first family member (count is 0)
            if (count === 0) {

	                    console.log(' first family member.');

                return true;
            } else {
                return false;
            }
        })
        .catch((error) => {
            console.error(`Error counting family members: ${error}`);
            throw error; // You can handle the error as needed
        });
}

	    function checkFirstMember(currentFamilyID, memberID){
isFirstChild(currentFamilyID)
    .then((isFirst) => {
        if (isFirst) {
            console.log("This is the first family member.");
            // Perform actions for the first family member here
			                    console.log('setRootValue memberID.',memberID);

setRootValue(memberID);
	    
        } else {
            console.log("This is not the first family member.");
            // Perform actions for non-first family members here
        }
    })
    .catch((error) => {
        console.error(`Error checking if it's the first family member: ${error}`);
    });
	    }


        
    
        // Function to get the treeId from query parameters
        function getTreeIdFromQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("tree");
        }
var Current_USERNAME = '';
var Current_USERPHOTO = '';
        // Function to display tree details
        function displayTreeDetails(tree) {
            document.getElementById("tree-name").value = tree.name;
            document.getElementById("tree-location").value = tree.location;
            document.getElementById("tree-description").value = tree.description;

        }

        // Function to display family members
  async function displayFamilyMembers(treeID) {
	  		loadPosts();
if(!treeID){
		return;
	}
    const familyMembersContainer = document.getElementById("family-members");
    familyMembersContainer.innerHTML = ""; // Clear existing members

    const familyMembersCollection = firestore.collection('familyMembers');

    try {
const querySnapshot = await familyMembersCollection.where('familyID', 'array-contains', treeID).get();

        querySnapshot.forEach((member) => {
            const data = member.data();
            // Implement dynamic population of family member details here
let claim_Div = "";		
if(data.userID === userID ){
 Current_USERNAME = data.first_name;
 Current_USERPHOTO = data.photo;
claim_Div = "<button class='edit-member'>Edit Member</button>";
}else{
if(data.userID === "" ){
claim_Div = "<button class='claim-member'>Claim Member</button>";
}
	
}
	                //console.log('userID ID:', userID);
	                //console.log('data.userID ID:', data.userID);
	
            const memberDiv = document.createElement("div");
        memberDiv.className = 'family-member';
            memberDiv.innerHTML = `
 <button class="add-parent">Add Parent</button>
            <div class="member-details">
                <!-- Member details go here -->
               <p>Name: ${data.first_name} ${data.last_name}</p>
                <p>Birthdate: ${data.birthdate}</p>
            ${claim_Div}
                <!-- Add other fields as needed -->
  
            </div>
            <button class="add-spouse">Add Spouse</button>
            <button class="add-child">Add Child</button>
            <button class="add-sibling">Add Sibling</button>
        `;
//showMainMessage("data "+ data);

        // Add event listeners for each button in the new family member
   const addParentBtn = memberDiv.querySelector('.add-parent');
addParentBtn.addEventListener('click', () => addParent(data));

const addSpouseBtn = memberDiv.querySelector('.add-spouse');
addSpouseBtn.addEventListener('click', () => addSpouse(data));

const addChildBtn = memberDiv.querySelector('.add-child');
addChildBtn.addEventListener('click', () => addChild(data));

const addSiblingBtn = memberDiv.querySelector('.add-sibling');
addSiblingBtn.addEventListener('click', () => addSibling(data));

if (data.userID === userID) {
    const editMemberBTN = memberDiv.querySelector('.edit-member');
    editMemberBTN.addEventListener('click', () => editMemberFunc(data));
} else {
    if (data.userID === "") {
        const claimMemberBTN = memberDiv.querySelector('.claim-member');
        claimMemberBTN.addEventListener('click', () => claimMemberFunc(data));
    }
}

    
            familyMembersContainer.appendChild(memberDiv);

		initializeFamilyTreeChart();
        });
    } catch (error) {
        console.error('Error displaying family members:', error);
    }
}

	    function claimMemberFunc(member){
showMainMessage("claim "+member.memberID);

let memberID = member.memberID;
            const userDocRef = firestore.collection('familyMembers').doc(memberID);

                        // Update the user document to add the family tree ID to the "userTrees" array field
                        userDocRef.update({
                            userTrees: firebase.firestore.FieldValue.arrayUnion(userID)
                        })
                            .then(() => {
                                console.log('Family tree ID added to user document successfully.');
			newsPost(`Admin ID ${familyTreeData.adminID} created ${familyTreeData.name} on ${familyTreeData.timestamp} `);
                loadFamilyTreeChart(treeData);

                            })
                            .catch((error) => {
                                console.error('Error adding family tree ID to user document:', error);
                            });



	    
	newsPost(`${userID} claimed ${member.first_name} ${member.last_name} `);

	    }	    
	    function editMemberFunc(member){
showMainMessage(`${userID} edit ${member.first_name} ${member.last_name} `);

	    }


	    var addFamily_Type = '';
	    var addFamily_MemberID = '';
	    var addFamily_MemberData = '';

	function showAddMemberTypePopup(xxx) {
	document.getElementById('memberType').innerHTML = "Add Member " + xxx;    
	document.getElementById('memberTypeBTN').innerHTML = "Add Member "+ xxx;
		
		const modal = document.getElementById('add-member-type');
    modal.style.display = 'block';
}

// Function to close the add member modal
function closeAddMemberTypePopup() {
	document.getElementById('memberType').innerHTML = "";    
	document.getElementById('memberTypeBTN').innerHTML = "";  
	
	const modal = document.getElementById('add-member-type');
    modal.style.display = 'none';
	addFamily_Type = '';
	    addFamily_MemberID = '';
	addFamily_MemberData = '';

}

// Close the modal if the user clicks outside of it
window.onclick = function(event) {
    const modal = document.getElementById('add-member-type');
    if (event.target === modal) {
        modal.style.display = 'none';
	document.getElementById('memberType').innerHTML = "";    
	document.getElementById('memberTypeBTN').innerHTML = "";  
	    addFamily_Type = '';
	    addFamily_MemberID = '';
	    addFamily_MemberData = '';

    }
};


//  addChildToParent(newID, addFamily_MemberID);  Parent
// addSpouse(newID, addFamily_MemberID); Spouse
// addSiblings(newID, addFamily_MemberID);  Sibling
// addParentTChild(newID, addFamily_MemberID); Child
	    
function addNewFamilyMember() {
    // Get input values
    const first_name = document.getElementById('member-first_name_type').value;
    const last_name = document.getElementById('member-last_name_type').value;
    const birthdate = document.getElementById('member-birthdate_type').value;
    const deceaseddate = document.getElementById('member-deceaseddate_type').value;
    const note = document.getElementById('member-note_type').value;

    if (!first_name && !last_name) {
        return;
    }

    // Create a new family member document and add it to the database
    const familyMember = {
        first_name: first_name,
        last_name: last_name,
        location: "",
        birthdate: birthdate,
        deceaseddate: deceaseddate,
	    photo: '',
        private: false,
        addByID: userID,
        familyID: [currentFamilyID], // Initialize familyID as an array with currentFamilyID
        userID: "",
        memberID: "",
        spouse: [],
        parents: [],
        sibling: [],
        children: [],
        contact: '',
        note: note,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),

        // Add other fields as needed
    };

    // Add the family member to the 'familyMembers' collection
    firestore.collection('familyMembers').add(familyMember)
        .then((docRef) => {
       
               let newID = docRef.id;


           
			
const selectedFile = document.getElementById('newMember_main_Image').files[0]; // Get the selected file

		if(!selectedFile){
     firestore.collection('familyMembers').doc(docRef.id).update({
                                    memberID: newID,
                                })
                                .then(() => {
					      // Display updated family members
                    displayFamilyMembers(currentFamilyID);
                loadFamilyTreeChart(treeData);

    // Close the modal after adding the member
    closeAddMemberTypePopup();	
                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });
		}else{
// Upload an image to gs://wefamily-44c0b.appspot.com/member_main_Image
uploadImageToStorage(
  selectedFile,
  'newMember_main_Image',
  (downloadURL) => {
    console.log('Image uploaded successfully to member_main_Image:', downloadURL);
    // Handle success, e.g., save the downloadURL to your database
   // Update the family tree document with the photo URL
                                firestore.collection('familyMembers').doc(docRef.id).update({
                                    memberID: newID,
                                    photo: downloadURL,
                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');


                    if (addFamily_Type === "Parent") {
                        addChildToParent(newID, addFamily_MemberID);
                        newsPost(`${userID} added ${addFamily_MemberData.first_name} ${addFamily_MemberData.last_name} as ${familyMember.first_name} ${familyMember.last_name} Parent`);
                    } else if (addFamily_Type === "Spouse") {
                        addSpouseToMember(newID, addFamily_MemberID);
                        newsPost(`${userID} added ${addFamily_MemberData.first_name} ${addFamily_MemberData.last_name} as ${familyMember.first_name} ${familyMember.last_name} Spouse`);
                    } else if (addFamily_Type === "Child") {
                        addParentToChild(addFamily_MemberID, newID);
                        newsPost(`${userID} added ${addFamily_MemberData.first_name} ${addFamily_MemberData.last_name} as ${familyMember.first_name} ${familyMember.last_name} Child`);
                    } else if (addFamily_Type === "Sibling") {
                        addSiblingToMember(newID, addFamily_MemberID);
                        newsPost(`${userID} added ${addFamily_MemberData.first_name} ${addFamily_MemberData.last_name} as ${familyMember.first_name} ${familyMember.last_name}} Sibling`);
                    }

					
                    // Display updated family members
                    displayFamilyMembers(currentFamilyID);
                loadFamilyTreeChart(treeData);

    // Close the modal after adding the member
    closeAddMemberTypePopup();

	
                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });
	  
  },
  (error) => {
    console.error('Image upload error:', error);
    // Handle error, e.g., display an error message to the user
  }
);

		}
                })
                .catch((error) => {
                    console.error('Error updating family member:', error);
                });
      

}

// Add an event listener to the form submission
document.getElementById('add-member-type').addEventListener('submit', function (e) {
    e.preventDefault(); // Prevent form submission

    // Call the function to add the family member
    addNewFamilyMember();
});


	    
    function addParent(member) {
                  //  console.log('member:'+ member);
        // Add parent logic here
showAddMemberTypePopup("Parent");
	    addFamily_MemberID = member.memberID;
	    addFamily_Type = 'Parent';
addFamily_MemberData = member;

    }

    function addSpouse(member) {
                   // console.log('member:'+ member);

	   // showMainMessage("?????");
        // Add spouse logic here
showAddMemberTypePopup("Spouse");
	    addFamily_MemberID = member.memberID;
	    addFamily_Type = 'Spouse';
addFamily_MemberData = member;

    }

    function addChild(member) {
             //       console.log('member:'+ member);

        // Add child logic here
showAddMemberTypePopup("Child");
	    addFamily_MemberID = member.memberID;
	    addFamily_Type = 'Child';
addFamily_MemberData = member;

    }

    function addSibling(member) {
                 //   console.log('member:'+ member);

        // Add sibling logic here
showAddMemberTypePopup("Sibling");
	    addFamily_MemberID = member.memberID;
	    addFamily_Type = 'Sibling';
addFamily_MemberData = member;

    }
	    
// Function to add a parent to a child
function addParentToChild(newID, addFamily_MemberID) {
	     

    const childRef = firestore.collection('familyMembers').doc(newID);
    const parentRef = firestore.collection('familyMembers').doc(addFamily_MemberID);

    // Update the child's parents array to include the parent's ID
   /* childRef.update({
        parents: firebase.firestore.FieldValue.arrayUnion(addFamily_MemberID)
    });
*/
    // Update the parent's children array to include the child's ID
    parentRef.update({
        children: firebase.firestore.FieldValue.arrayUnion(newID)
    });
				setRootValue(newID);
			loadFamilyTreeChart();
}


// Function to add siblings to each other's sibling arrays
function addSiblingToMember(newID, addFamily_MemberID) {
    const memberRef1 = firestore.collection('familyMembers').doc(newID);
    const memberRef2 = firestore.collection('familyMembers').doc(addFamily_MemberID);

    // Update the sibling arrays for both members
    memberRef1.update({
        sibling: firebase.firestore.FieldValue.arrayUnion(addFamily_MemberID)
    });
    
    memberRef2.update({
        sibling: firebase.firestore.FieldValue.arrayUnion(newID)
    });
}

// Function to add parent-child relationship
function addChildToParent(newID, addFamily_MemberID) {
    const parentRef = firestore.collection('familyMembers').doc(newID);
    const childRef = firestore.collection('familyMembers').doc(addFamily_MemberID);

    // Update the parent and child arrays
    parentRef.update({
        children: firebase.firestore.FieldValue.arrayUnion(addFamily_MemberID)
    });
			loadFamilyTreeChart();
   /* childRef.update({
        parents: firebase.firestore.FieldValue.arrayUnion(newID)
    });*/
}

// Function to add spouses to each other's spouse arrays
function addSpouseToMember(newID, addFamily_MemberID) {
    const memberRef1 = firestore.collection('familyMembers').doc(newID);
    const memberRef2 = firestore.collection('familyMembers').doc(addFamily_MemberID);

    // Update the spouse arrays for both members
    memberRef1.update({
        spouse: firebase.firestore.FieldValue.arrayUnion(addFamily_MemberID)
    });

    memberRef2.update({
        spouse: firebase.firestore.FieldValue.arrayUnion(newID)
    });
}

    
 
            



        // Call the fetchFamilyTree function on page load
        window.onload = fetchFamilyTree;

 
function limitPostContent() {
    const textarea = document.getElementById('post-content');
    const content = textarea.value;

    // Limit the post to 500 characters
    const truncatedContent = content.slice(0, 500);
    textarea.value = truncatedContent;
}

document.addEventListener('DOMContentLoaded', function () {
    const textarea = document.getElementById('post-content');
    textarea.addEventListener('input', limitPostContent);
});




	
    </script>

    <script defer src="family-tree-script.js"></script>

	</body>
  <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2023 WeFamily. All rights reserved.<a id="LRP" href='https://rw-501.github.io/Portfolio/'>Dev Portfolio</a> </p>
        </div>
    </footer>

	
</html>
