<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
  <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script src="../auth.js"></script>
    <script src="../firebase.js"></script>
    <script src="familytree.js"></script>
    <title>Family Tree Management</title>
      <style>
        /* Add your CSS styles here */
        /* Styles for the pop-up */
        .popup-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .popup {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            margin:  auto;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    top: 0;
    width: fit-content;
    height: fit-content;
        }

        /* Styles for the "Join a family tree" button */
        #join-tree-button {
            margin-top: 20px;
            display: block;
            text-align: center;
        }

          /* Define a CSS class to hide elements */
.hidden {
    display: none;
}

    </style>
</head>
<body>
    <div class="container">
        <h1>Family Tree Management</h1>
        <div id="family-tree-container">
            <button onclick="openPopup()">Create Family Tree</button>
            <div id="tree-details">
                <h2>Tree Details</h2>
                <label for="tree-name">Name:</label>
                <input type="text" id="tree-name" placeholder="Family Tree Name" required>
                <label for="tree-location">Location:</label>
                <input type="text" id="tree-location" placeholder="Location">
                <label for="tree-description">Description:</label>
                <textarea id="tree-description" placeholder="Brief Description"></textarea>
            </div>
            <div id="tree-content">
                <h2>Family Tree</h2>
                <div id="family-members">
                    <!-- Family member details will be added here dynamically -->
                </div>
                <button id="add-member" onclick="showAddMemberModal()">Add Family Member</button>
            </div>
        </div>
    </div>

   <!-- Pop-up for creating a family tree -->
    <div class="popup-container" id="popup-container">
        <div class="popup">
            <span onclick="closePopup()" class="close-button">&times;</span>
            
<div id="create-tree-section" class="tree-section">
            <h2>Create a Family Tree</h2>
                <p>
                <label for="tree_name">Name:</label>
                <input type="text" id="tree_name" placeholder="Family Tree Name" required>
                    </p><p>
                <label for="tree_location">Location:</label>
                <input type="text" id="tree_location" placeholder="Location">
                </p>
                <label for="tree_public">Public:</label>
                 <input type="radio" id="tree_public" placeholder="public" checked>
                </p><p>
                <label for="tree_code">Code:</label>
                <input type="text" id="tree_code" placeholder="code">
                </p><p>
                <label for="tree_description">Description:</label>
                <textarea id="tree_description" placeholder="Brief Description"></textarea>
                </p>
                <button onclick="createFamilyTree()">Create</button>
            </div>
<div id="join-tree-section" class="tree-section hidden">
            <h2>Join a Family Tree</h2>
<div id="search-family-tree">
    <h2>Search for a Family Tree</h2>
    <input type="text" id="family-tree-search" placeholder="Enter Family Tree Name">
    <button id="search-button">Search</button>
</div>

<div id="enter-family-tree-code">
    <h2>Enter Family Tree Code</h2>
    <input type="text" id="family-tree-code" placeholder="Enter Code">
    <button id="enter-code-button">Enter</button>
</div>



                     </div>
<hr>
                    <button id="join-create-button" onclick="toggleTreeSections()">Join a family tree</button>

        </div>
    </div>

<div id="add-member-modal" class="popup-container">
    <div class="popup">
        <span class="close" onclick="closeAddMemberModal()">&times;</span>
        <h2>Add Family Member</h2>
        <form id="add-member-form">
            <p>
            <label for="member-first_name">First Name:</label>
            <input type="text" id="member-first_name" required>
                </p><p>
<label for="member-last_name">Last Name:</label>
            <input type="text" id="member-last_name" required>
                </p><p>
            <label for="member-birthdate">Birthdate:</label>
            <input type="date" id="member-birthdate" required>
                    </p><p>
            <label for="member-photo">Photo URL:</label>
            <input type="text" id="member-photo">
                        </p><p>
            <label for="member-private">Private:</label>
            <input type="checkbox" id="member-private">
                            </p><p>
            <label for="member-contact">Contact:</label>
            <input type="text" id="member-contact">
                                </p><p>
            <label for="member-note">Note:</label>
            <textarea id="member-note"></textarea>
                                </p>
            <button type="submit">Add Member</button>
        </form>
    </div>
</div>


    
    <script>
// Function to search for family tree names
function searchFamilyTrees() {
    const searchInput = document.getElementById("family-tree-search").value;

    // Perform a Firestore query to search for family trees by name
    firestore.collection("familyTrees")
        .where("name", "==", searchInput)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                // No matching family trees found
                alert("No matching family trees found.");
            } else {
                // Display the matching family trees (you can decide how to display them)
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("Family Tree Name:", data.name);
                    console.log("Family Tree Location:", data.location);
                    // Display more information as needed
                });
            }
        })
        .catch((error) => {
            console.error("Error searching for family trees:", error);
        });
}

// Function to get a family tree with the code
function getFamilyTreeWithCode() {
    const familyTreeCode = document.getElementById("family-tree-code").value;

    // Perform a Firestore query to get the family tree with the specified code
    firestore.collection("familyTrees")
        .where("code", "==", familyTreeCode)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                // No family tree found with the specified code
                alert("No family tree found with the entered code.");
            } else {
                // Retrieve the family tree (assuming there is only one match)
                const familyTreeDoc = querySnapshot.docs[0];
                const familyTreeData = familyTreeDoc.data();

                // Use the family tree data as needed (e.g., display tree details)
                console.log("Family Tree Name:", familyTreeData.name);
                console.log("Family Tree Location:", familyTreeData.location);
                // Display more information as needed
            }
        })
        .catch((error) => {
            console.error("Error getting family tree with code:", error);
        });
}

// Add click event listeners to the search and enter code buttons
document.getElementById("search-button").addEventListener("click", searchFamilyTrees);
document.getElementById("enter-code-button").addEventListener("click", getFamilyTreeWithCode);

        // Function to toggle the visibility of Create Tree and Join Tree sections
function toggleTreeSections() {
    const createTreeSection = document.getElementById("create-tree-section");
    const joinTreeSection = document.getElementById("join-tree-section");
    const join_create_btn = document.getElementById("join-create-button");

    // Check if the Create Tree section is currently visible
    if (!createTreeSection.classList.contains("hidden")) {
        // Hide the Create Tree section
        createTreeSection.classList.add("hidden");
        // Show the Join Tree section
        joinTreeSection.classList.remove("hidden");
        join_create_btn.innerHTML= "Create Family Tree";
    } else {
        // Hide the Join Tree section
        joinTreeSection.classList.add("hidden");
        // Show the Create Tree section
        createTreeSection.classList.remove("hidden");
                join_create_btn.innerHTML= "Join Family Tree";

    }
}



// Function to display the add member modal
function showAddMemberModal() {
    const modal = document.getElementById('add-member-modal');
    modal.style.display = 'block';
}

// Function to close the add member modal
function closeAddMemberModal() {
    const modal = document.getElementById('add-member-modal');
    modal.style.display = 'none';
}

// Close the modal if the user clicks outside of it
window.onclick = function(event) {
    const modal = document.getElementById('add-member-modal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};

     // Function to open the pop-up
        function openPopup() {
            document.getElementById("popup-container").style.display = "flex";
        }

        // Function to close the pop-up
        function closePopup() {
            document.getElementById("popup-container").style.display = "none";
        }
var currentFamilyID = "";
        
function createFamilyTree() {
    const treeName = document.getElementById("tree_name").value;
    const treeLocation = document.getElementById("tree_location").value;
    const treeDescription = document.getElementById("tree_description").value;
    const pubicBool = document.getElementById("tree_public").value;
    const familyCode = document.getElementById("tree_code").value;

    // Perform data validation
    if (!treeName || !treeLocation || !familyCode) {
        alert("Please fill in all required fields.");
        return;
    }

    // Create an object to represent the family tree data
    const familyTreeData = {
        name: treeName,
        location: treeLocation,
        description: treeDescription,
        adminID: userID,
        public: pubicBool,
        familyCode: familyCode,
        photo: "",
        // Add more fields as needed
    };

    // Add the family tree to Firestore
    firestore.collection('familyTrees').add(familyTreeData)
        .then((docRef) => {
            console.log('Family tree added with ID:', docRef.id);
            // You can perform further actions or navigation after successfully adding the family tree
            currentFamilyID = docRef.id;
            // Close the pop-up after creating the family tree

const familyTreeId = currentFamilyID; // Replace with the actual family tree ID

// Reference to the user document in Firestore
const userDocRef = firestore.collection('users').doc(userId);

// Update the user document to add the family tree ID to the "userTrees" array field
userDocRef.update({
    userTrees: firebase.firestore.FieldValue.arrayUnion(familyTreeId)
})
.then(() => {
    console.log('Family tree ID added to user document successfully.');
})
.catch((error) => {
    console.error('Error adding family tree ID to user document:', error);
});


            
            closePopup();

            showAddMemberModal();
        })
        .catch((error) => {
            console.error('Error adding family tree:', error);
        });
}




          
        

async function getFamilyTree(treeId) {
    try {
        // Reference to the Firestore collection
        const familyTreesCollection = firestore.collection('familyTrees');

        // Query the collection for the specific treeId
        const querySnapshot = await familyTreesCollection.where('treeId', '==', treeId).get();

        // Check if a document matching the query exists
        if (querySnapshot.empty) {
            console.log('No matching documents.');
            return null;
        }

        // Retrieve the data from the first matching document (assuming treeId is unique)
        const familyTreeData = querySnapshot.docs[0].data();

        return familyTreeData;
    } catch (error) {
        console.error('Error getting family tree:', error);
        return null;
    }
}

        function getFamilyTree(){

// Reference to the user document in Firestore
const userDocRef = firestore.collection('users').doc(userId);

// Get the user document from Firestore
userDocRef.get()
    .then((doc) => {
        if (doc.exists) {
            // Check if the user document has a "userTrees" field (an array of family tree IDs)
            if (doc.data().userTrees && doc.data().userTrees.length > 0) {
                // Get the first family tree ID from the user's array of family tree IDs
                const familyTreeId = doc.data().userTrees[0]; // You can modify this to get the desired family tree ID
                console.log('User has a family tree with ID:', familyTreeId);
            } else {
                console.log('User does not have any family trees.');
                openPopup();
            }
        } else {
            console.log('User document does not exist.');
                            window.location.href = "index.html";

        }
    })
    .catch((error) => {
        console.error('Error getting user document:', error);
    });

        }

        // JavaScript functions for family tree management
        async function fetchFamilyTree() {
            // Fetch and display the family tree details and members from Firestore
            const user = checkUserLogin();
             console.log(`44 dash user: ${user} `);
            if (user) {
                const treeId = getTreeIdFromQueryParams();
                if (treeId) {
                    const tree = await getFamilyTree(treeId);
                    if (tree) {
                        displayTreeDetails(tree);
                        displayFamilyMembers(tree);
                    } else {
                        // Handle tree not found
                      //  console.log(`question ${pollData.question} `);
                        console.log(`Handle tree not found `);
                        getFamilyTree();

                        
                    }
                } else {
                    // Handle missing treeId parameter
                                            console.log(`Handle missing treeId parameter`);
getFamilyTree();
                }
            } else {
                // Redirect to login page if the user is not logged in
                window.location.href = "index.html";
                                        console.log(` user is not logged in `);

            }
        }

        // Function to add a new family member
// Function to add a family member
function addFamilyMember() {
    // Get input values
    const first_name = document.getElementById('member-first_name').value;
    const last_name = document.getElementById('member-last_name').value;
    const birthdate = document.getElementById('member-birthdate').value;
    const photo = document.getElementById('member-photo').value;
    const isPrivate = document.getElementById('member-private').checked;
    const contact = document.getElementById('member-contact').value;
    const note = document.getElementById('member-note').value;

    // You can perform data validation and error handling here

    // Create a new family member document and add it to the database
    const familyMember = {
        first_name: first_name,
        last_name: last_name,
        birthdate: birthdate,
        photo: photo,
        private: isPrivate,
        addByID: userID,
        familyID: [currentFamilyID], // Initialize familyID as an array with currentFamilyID
        spouse: [],
        parents: [],
        children: [],
        contact: contact,
        note: note,
        // Add other fields as needed
    };

    // Add the family member to the database (you will need to implement this)
    // Example: firestore.collection('familyMembers').add(familyMember);

    // Close the modal after adding the member
    closeAddMemberModal();
}

document.getElementById('add-member-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent form submission
    addFamilyMember(); // Call the function to add the family member
});




        
    
        // Function to get the treeId from query parameters
        function getTreeIdFromQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("user");
        }

        // Function to display tree details
        function displayTreeDetails(tree) {
            document.getElementById("tree-name").value = tree.name;
            document.getElementById("tree-location").value = tree.location;
            document.getElementById("tree-description").value = tree.description;
        }

        // Function to display family members
        function displayFamilyMembers(members) {
            const familyMembersContainer = document.getElementById("family-members");
            familyMembersContainer.innerHTML = ""; // Clear existing members

            members.forEach((member) => {
                // Implement dynamic population of family member details here
            });
        }

        // Call the fetchFamilyTree function on page load
        window.onload = fetchFamilyTree;
    </script>
</body>
</html>
