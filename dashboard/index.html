<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.2/purify.min.js"></script>


	
      <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

	
    <script src="../auth.js"></script>
    <script src="../firebase.js"></script>

	    <script src="https://d3js.org/d3.v7.min.js"></script>

    <title>Linkedup</title>

	


<script>
function initializeFamilyTreeChart() {
  const familyMembers = document.querySelectorAll('.family-member');

  familyMembers.forEach((member) => {
    const memberName = member.querySelector('.member-details');
    const buttons = member.querySelectorAll('button');

    memberName.addEventListener('click', () => {
      buttons.forEach((button) => {
        button.style.display = button.style.display === 'none' ? 'inline-block' : 'none';
      });
    });
  });
}


</script>
</head>
<body>
    <!-- Navigation Bar -->
   <nav class="navbar">
    <div class="container">
        <div class="logo">
            <a id="logo-link" href="/wefamily/dashboard/">WeFamily</a>
        </div>
        <div class="navbar-toggler">
            <div class="menu-icon">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </div>
        <ul class="nav-links">
            <li><a href="#tree-details">Tree Details</a></li>
            <li><a href="#tree-content">Family Members</a></li>
            <li><a href="#family-tree">Family Tree</a></li>
            <li><a href="#family-news">Family Chat</a></li>
            <li><a href="#member_request">Member Request</a></li>
            <li><a href="/wefamily/about/">About</a></li>
        </ul>
        <div class="user-actions">
            <button id="logout-button" onclick="logoutUser()">Logout</button>
        </div>
    </div>
    <div class="dropdown-menu">
        <ul>
            <li><a href="#tree-details">Tree Details</a></li>
            <li><a href="#tree-content">Family Members</a></li>
            <li><a href="#family-tree">Family Tree</a></li>
            <li><a href="#family-news">Family Chat</a></li>
            <li><a href="#member_request">Member Request</a></li>
            <li><a href="/wefamily/about/">About</a></li>
        </ul>
    </div>
</nav>




	
    <div class="container">
        <h1>Family Tree Management</h1>
        <div id="family-tree-container">
            <button onclick="openPopup()">Join / Create Family Tree</button>
            <div id="tree-details">
                <h2>Tree Details</h2><button onclick="openEditFamilyTreePopup()">Edit</button>

		    <div class="space_J">
    <div class="image-container w30">
  
        <img class="uploaded-image" src="/wefamily/images/imgPlacehoder.png" alt="Uploaded Image">

    </div>
		    <div class="w70">
                <label for="tree-name">Name:</label>
                <input type="text" id="tree-name" placeholder="Family Tree Name" required>
                <label for="tree-location">Location:</label>
                <input type="text" id="tree-location" placeholder="Location">
                <label for="tree-description">Description:</label>
                <textarea id="tree-description" placeholder="Brief Description"></textarea>
		    </div></div>
            </div>
            <div id="tree-content">
             			    <div class="space_J">
  <h2>Family Members</h2><small id="familyCount"></small></div>
                <div id="family-members">
                    <!-- Family member details will be added here dynamically -->
                </div>
                <button id="add-member" onclick="showAddMemberModal()">Add Family Member</button>
            </div>


		
            <div id="family-tree">
              <div>  <h2>Family Tree</h2></div>
		    <div class="space_J" id="zoom-controls">
<div>
	<button id="export-button">Export as Image</button>
</div>
			   <div> 
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>
			   </div>
</div>

                <svg id="family-tree-area">
       
                </svg>
		    
            </div>

		
<div id="family-news">
    <h2>Family Chat</h2>
	
    <div id="mainFamily-news-area">
<div id="pinnedFamily-news-area"></div>
    <div id="family-news-area">
        <!-- Posts will be added here dynamically -->
    </div>
    </div>
	
    <textarea id="post-content" placeholder="Write your post..."></textarea>

			    <div class="space_J">
			    <div class="flex">
		 <!-- Image container with onclick event -->
    <div class="post-image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img id="postPic_img" class="uploaded-image" src="/wefamily/images/imgPlacehoder2.png" alt="Uploaded Image">
        <!-- File input element -->
        <input id="members_post_images" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
				   <div> <button onclick="addPost()">Add Post</button></div>
  </div>



	  <!-- Add a button to enable/disable the newsPost function -->
  <div class="flex">  <button id="toggleNewsButton">System Posting</button>

	<button class="posts-buttons" onclick="loadFamilyPosts()">Member Posts</button>
	<button class="posts-buttons" onclick="loadPosts()">All Posts</button></div>
</div>
</div>



            
 <div id="member_Request">
                <h2>Family Member Request</h2>
                    <button class="memberRequest" onclick="openJoinRequestPopup()">View Member Request</button>

 </div>

</div>
    </div>
    
   <!-- Pop-up for creating a family tree -->
    <div class="popup-container" id="popup-container">
        <div class="popup">
            <span onclick="closePopup()" class="close-button">&times;</span>
            
<div id="create-tree-section" class="tree-section">
            <h2>Create a Family Tree</h2>
<p>
		 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img class="uploaded-image" src="/wefamily/images/imgPlacehoder.png" alt="Uploaded Image">
        <!-- File input element -->
        <input id="family_Tree_Image" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>

</p>
                <p>
                <label for="tree_name">Name:</label>
                <input type="text" id="tree_name" placeholder="Family Tree Name" required>
                    </p><p>
                <label for="tree_location">Location:</label>
                <input type="text" id="tree_location" placeholder="Location">
                </p>
                <label for="tree_public">Public:</label>
                 <input type="radio" id="tree_public" placeholder="public" checked>
                </p><p>
                <label for="tree_code">Code:</label>
                <input type="text" id="tree_code" placeholder="JoeFam411">
                </p><p>
                <label for="tree_description">Description:</label>
                <textarea id="tree_description" placeholder="Brief Description"></textarea>
                </p>
                <button id="createBTN" onclick="createFamilyTree()">Create</button>
            </div>
<div id="join-tree-section" class="tree-section hidden">
            <h2>Join a Family Tree</h2><hr>
<div id="search-family-tree">
    <h2>Search for a Family Tree</h2>
    <input type="text" id="family-tree-search" placeholder="Enter Family Tree Name">
    <button id="search-button">Search</button>
</div>

<div id="enter-family-tree-code">
    <h2>Enter Family Tree Code</h2>
    <input type="text" id="family-tree-code" placeholder="Enter Code">
    <button id="enter-code-button">Enter</button>
</div>
 </div>
<div id="join-familytree-section" class="tree-section hidden">
    <h2>Join Request</h2>

            <label for="join_tree_name">Family Tree:</label>
    <div id="join_tree_name">tree name</div>
    
            <label for="join_tree_location">Locations:</label>
    <div id="join_tree_location">family locations</div>
<hr>
   <form id="join-request-form">
        <label for="request_first-name">First Name:</label>
        <input type="text" id="request_first-name" required><br><br>
        
        <label for="request_last-name">Last Name:</label>
        <input type="text" id="request_last-name" required><br><br>
        
        <label for="request_location">Location:</label>
        <input type="text" id="request_location" required><br><br>
        
        <label for="request_note">Note:</label>
        <textarea id="request_note"></textarea><br><br>
        
        <button type="button" onclick="joinRequestFunc()">Resquest To Join</button>
                <button  type="button" onclick="toggleJoinTree()">Back</button>
    </form>
    
</div>       
            <hr>
                    <button id="join-create-button" onclick="toggleTreeSections()">Join a family tree</button>

        </div>
    </div>

<div id="add-member-modal" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeAddMemberModal()">&times;</span>
        <h2>Add Family Member</h2>
        <form id="add-member-form">
            <p>
	 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img id="member_Image" class="uploaded-image" src="/wefamily/images/memberPlaceholder.jpg" alt="Uploaded Image">
        <!-- File input element -->
        <input id="member_main_Image" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
		    	    </p>
		<p>
            <label for="member-first_name">First Name:</label>
            <input type="text" id="member-first_name" required>
                </p><p>
<label for="member-last_name">Last Name:</label>
            <input type="text" id="member-last_name" required>
                </p><p>
            <label for="member-birthdate">Birthdate:</label>
            <input type="date" id="member-birthdate" required>
                    </p><p>
            <label for="member-private">Private:</label>
            <input type="checkbox" id="member-private">
                            </p><p>
            <label for="member-contact">Contact:</label>
            <input type="text" id="member-contact">
                                </p><p>
            <label for="member-note">Note:</label>
            <textarea id="member-note"></textarea>
                                </p>
            <button type="submit">Add Member</button>
        </form>
    </div>
</div>

<div id="join-request-popup" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeJoinRequestPopup()">&times;</span>
        <h2>Join Requests</h2>
        <ul id="join-request-list">
            <!-- Join requests will be added here dynamically -->
             <div>Loading</div>
        </ul>
    </div>
</div>
    <div class="mainMessage-box" id="mainMessageBox">
  <div class="mainMessage-content">
    <p id="mainMessageText">Your message here</p>
    <button id="mainCloseButton">Close</button>
  </div>
</div>

	<div id="add-member-type" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeAddMemberTypePopup()">&times;</span>
        <h2 id="memberType" >Add Family Member</h2>
        <form id="add-member-form">
<p>
	 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img class="uploaded-image" src="/wefamily/images/memberPlaceholder.jpg" alt="Uploaded Image">
        <!-- File input element -->
        <input id="newMember_main_Image" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
		
	</p>	
            <p>
            <label for="member-first_name_type">First Name:</label>
            <input type="text" id="member-first_name_type" required>
                </p><p>
<label for="member-last_name_type">Last Name:</label>
            <input type="text" id="member-last_name_type" required>
                </p><p>
            <label for="member-birthdate_type">Birthdate:</label>
            <input type="date" id="member-birthdate_type" required>
                    </p><p>           
	<label for="member-deceaseddate_type">Deceased Date:</label>
            <input type="date" id="member-deceaseddate_type" >
                    </p><p>
            <label for="member-note_type">Note:</label>
            <textarea id="member-note_type"></textarea>
                                </p>
            <button type="submit" id="memberTypeBTN">Add Member</button>
        </form>
    </div>
</div>





	
<div id="memberDetailPopup" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="hideMemberPopup()">&times;</span>
        <h2 id="memberName">Add Family Member</h2>
        <div class="popup-content">
            <div class="popup-left">
                <div class="popup-image">
                    <img id="memberImage" src="" alt="Member Image">
                </div>
                <div class="popup-text">
                    <textarea id="memberInfo" placeholder="Member Info"></textarea>
                </div>
            </div>
            <div class="popup-right">
                <ul id="memberDetails">
                    <!-- Member details will be populated here -->
                </ul>
		      <button id="scrollTo">Edit</button>

            </div>
        </div>
    </div>
</div>


	
 <div id="edit-family-tree-popup" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeEditFamilyTreePopup()">&times;</span>
        <h2>Edit Family Tree</h2>
        				 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img class="uploaded-image" src="/wefamily/images/imgPlacehoder.png" alt="Uploaded Image">
        <!-- File input element -->
        <input id="family_Tree_ImageEdit" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
        <label for="editFamilyTreeName">Name:</label>
        <input type="text" id="editFamilyTreeName" placeholder="Family Name">
        
        <label for="editFamilyTreeDescription">Description:</label>
        <input type="text" id="editFamilyTreeDescription" placeholder="Family Description">
        
        <label for="editFamilyTreeLocation">Location:</label>
        <input type="text" id="editFamilyTreeLocation" placeholder="Location">
        
        <button onclick="saveEditedFamilyTree()">Save Changes</button>
    </div>
</div>



<div id="edit-family-member-popup" class="popup-container">
    <div class="popup">
        <span class="close-button" onclick="closeEditFamilyMemberPopup()">&times;</span>
        <h2>Edit Family Member</h2>

<div class="flex">
	    	 <!-- Image container with onclick event -->
    <div class="image-container w30" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img id="edit_member_Image" class="uploaded-image" src="/wefamily/images/memberPlaceholder.jpg" alt="Uploaded Image">
        <!-- File input element -->
        <input id="edit-photo-file" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
	    <div class="grid">
        <input type="text" id="edit-first-name" placeholder="First Name">
        <input type="text" id="edit-last-name" placeholder="Last Name">
        <input type="date" id="edit-birthdate" placeholder="Birthdate">
        <!-- Add other fields as needed (contact, location, etc.) -->
        <textarea id="edit-note" placeholder="Note"></textarea>
		    <div class="space_J">

        <button onclick="saveEditedFamilyMember()">Save</button><button onclick="removeFamilyMember()">Remove</button>
   </div>
		    <small class="userID" id="userID_edit_Member"></small>
	    </div></div>
    </div>
</div>




	
    <script>
var currentFamilyID = "";
var requestFamilyID = "";
// Add this JavaScript code in your script section




function setupEnterKeyNavigation(inputIdArray) {
  inputIdArray.forEach((inputId, index) => {
    const inputElement = document.getElementById(inputId);

    inputElement.addEventListener('keydown', event => {
      if (event.key === 'Enter') {
        event.preventDefault();
       // addPost();

        const nextInput = inputIdArray[index + 1];
        if (nextInput) {
          document.getElementById(nextInput).focus();
        }
      }
    });
  });
}

// Call the function and provide an array of input IDs to navigate
const inputIdsToNavigate = ['post-content','editFamilyTreeName', 'editFamilyTreeDescription', 'editFamilyTreeLocation','edit-first-name','edit-last-name','edit-birthdate','member-first_name','member-last_name','member-birthdate','member-contact','member-note','tree_name','tree_location','tree_code','tree_description','family-tree-search','family-tree-code'];
setupEnterKeyNavigation(inputIdsToNavigate);




	    

// Function to open the edit family tree popup and populate fields with existing data
function openEditFamilyTreePopup() {
    const popup = document.getElementById('edit-family-tree-popup');
    popup.style.display = 'block';

    // Populate fields with existing data
    document.getElementById('editFamilyTreeName').value =  document.getElementById('tree-name').value;
    document.getElementById('editFamilyTreeDescription').value =  document.getElementById('tree-description').value;
    document.getElementById('editFamilyTreeLocation').value =  document.getElementById('tree-location').value;
}

// Function to close the edit family tree popup
function closeEditFamilyTreePopup() {
    const popup = document.getElementById('edit-family-tree-popup');
    popup.style.display = 'none';
	     displayFamilyMembers(currentFamilyID);
                loadFamilyTreeChart(treeData);
}


//showMainMessage("message");

function handleResizeAndCrop(image) {
 // const image = document.getElementById('image');
  const resizableCropBox = document.getElementById('resizable-crop-box');
  let startX, startY;
  let isResizing = false;
  let isCropping = false;

  // Handle image resizing
  image.addEventListener('mousedown', (e) => {
    startX = e.clientX;
    startY = e.clientY;
    isResizing = true;
    document.addEventListener('mousemove', resizeImage);
    document.addEventListener('mouseup', stopResize);
  });

  function resizeImage(e) {
    if (!isResizing) return;
    const width = image.offsetWidth + (e.clientX - startX);
    const height = image.offsetHeight + (e.clientY - startY);
    image.style.width = `${width}px`;
    image.style.height = `${height}px`;
    startX = e.clientX;
    startY = e.clientY;
  }

  function stopResize() {
    isResizing = false;
    document.removeEventListener('mousemove', resizeImage);
    document.removeEventListener('mouseup', stopResize);
  }

  // Handle image cropping
  resizableCropBox.addEventListener('mousedown', (e) => {
    startX = e.clientX;
    startY = e.clientY;
    isCropping = true;
    document.addEventListener('mousemove', cropImage);
    document.addEventListener('mouseup', stopCrop);
  });

  function cropImage(e) {
    if (!isCropping) return;
    const rect = resizableCropBox.getBoundingClientRect();
    const offsetX = e.clientX - startX;
    const offsetY = e.clientY - startY;
    const newLeft = rect.left + offsetX;
    const newTop = rect.top + offsetY;
    resizableCropBox.style.left = `${newLeft}px`;
    resizableCropBox.style.top = `${newTop}px`;
    startX = e.clientX;
    startY = e.clientY;
  }

  function stopCrop() {
    isCropping = false;
    document.removeEventListener('mousemove', cropImage);
    document.removeEventListener('mouseup', stopCrop);
  }
}

// Call the function to set up resize and crop handlers
//handleResizeAndCrop();


// Open the file input dialog when the image container is clicked
function openFileInput(container) {
  container.querySelector('.file-input').click();
}

// Function to handle file upload and display the selected image
function handleFileUpload(input) {
  const file = input.files[0];

  if (file) {
    const uploadFileInput = input.previousElementSibling;
    uploadFileInput.src = URL.createObjectURL(file);
    const parentDiv = input.parentElement;

    // Get the img tag from the previous sibling
    const image = parentDiv.querySelector('img');

    // Create and display the resizable crop box
    const resizableCropBox = document.createElement('div');
    resizableCropBox.id = 'resizable-crop-box';
    const imageContainer = uploadFileInput.parentElement;
    imageContainer.appendChild(resizableCropBox);

    // Set initial position and size for the resizable crop box
    const imageRect = uploadFileInput.getBoundingClientRect();
    resizableCropBox.style.width = '100px'; // Set an initial width
    resizableCropBox.style.height = '100px'; // Set an initial height
    resizableCropBox.style.left = `${imageRect.left + imageRect.width / 2 - 50}px`; // Center horizontally
    resizableCropBox.style.top = `${imageRect.top + imageRect.height / 2 - 50}px`; // Center vertically

    // Call the function to set up resize and crop handlers
    handleResizeAndCrop(image);
  }
}







	    
async function uploadImageToStorage(file, storagePath, maxWidthx, maxHeightx, successCallback, errorCallback) {
  // Check if successCallback is a valid function
  if (typeof successCallback !== 'function') {
    console.error('Success callback is not a valid function.');
    return;
  }
	// Check if a file was selected
  if (!file) {
    if (errorCallback) errorCallback('Please select an image file.');
    return;
  }

  // Check file type (allow only images)
  if (!file.type.startsWith('image/')) {
    if (errorCallback) errorCallback('Please select an image file (e.g., JPEG or PNG).');
    return;
  }
let maxWidth = 500; 
let maxHeight = 500;
	
  const storageRef = firebase.storage().ref();
  const timestamp = Date.now();
  const filename = `${timestamp}_${file.name}`;
  const imageRef = storageRef.child(`${storagePath}/${filename}`);

  const img = new Image();
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  img.onload = () => {
    let newWidth, newHeight;
    if (img.width > img.height) {
      newWidth = maxWidth;
      newHeight = (img.height / img.width) * maxWidth;
    } else {
      newHeight = maxHeight;
      newWidth = (img.width / img.height) * maxHeight;
    }

    const cropX = (newWidth - maxWidth) / 2;
    const cropY = (newHeight - maxHeight) / 2;

    canvas.width = maxWidth;
    canvas.height = maxHeight;
    ctx.drawImage(img, -cropX, -cropY, newWidth, newHeight);

    canvas.toBlob((blob) => {
      const uploadTask = imageRef.put(blob);

      canvas.toBlob(async (blob) => {
    const uploadTask = imageRef.put(blob);

    uploadTask.on(
      'state_changed',
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        console.log(`Upload progress: ${progress}%`);
      },
      (error) => {
        console.error('Upload error:', error);
        if (errorCallback) errorCallback('Image upload failed.');
      },
      async () => {
        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
        console.log('Image URL:', downloadURL);
        successCallback(downloadURL);

        // Remove the resizable crop box after successful upload
        const cropBox = document.getElementById("resizable-crop-box");

        if (cropBox) {
          cropBox.parentElement.removeChild(cropBox);
        }
      }
    );
  }, 'image/jpeg', 0.9);
}





function openJoinRequestPopup() {
    document.getElementById('join-request-popup').style.display = 'block';
    loadJoinRequests(); // Load join requests when the pop-up is opened
}

function closeJoinRequestPopup() {
    document.getElementById('join-request-popup').style.display = 'none';
}

function acceptJoinRequest(requestID, userID) {

	if(!requestID && !userID){
		return;
	}
	
    // Update the user's document to add the currentFamilyID to the userTrees array
    firestore.collection('users').doc(userID)
        .update({
            userTrees: firebase.firestore.FieldValue.arrayUnion(currentFamilyID)
        })
        .then(() => {
		
            // Get the document reference
            const requestRef = firestore.collection('memberRequest').doc(requestID);
            
            // Get the field data before deleting the document
            requestRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        const requestData = doc.data();
                        
                   
                        // Delete the document
                        requestRef.delete()
                            .then(() => {
                                console.log('Join request accepted and deleted.');
                                loadJoinRequests(); // Reload the list of join requests
				    
newsPost(`${requestData.first_name} ${requestData.last_name} added to the Family Tree`);

                                // Now you can use 'requestData' to access the field data of the deleted document
                                console.log('Field data of deleted document:', requestData);
                            })
                            .catch((error) => {
                                console.error('Error deleting join request:', error);
                            });
                    } else {
                        console.log('Document does not exist.');
                    }
                })
                .catch((error) => {
                    console.error('Error getting join request document:', error);
                });
        })
        .catch((error) => {
            console.error('Error updating user document:', error);
        });
}


function declineJoinRequest(requestID) {
    // Delete the join request from the memberRequest collection
    firestore.collection('memberRequest').doc(requestID).delete()
        .then(() => {
            console.log('Join request declined and deleted.');
            loadJoinRequests(); // Reload the list of join requests
        })
        .catch((error) => {
            console.error('Error deleting join request:', error);
        });
}



        
function loadJoinRequests() {
    // Get the join requests for the current family tree (currentFamilyID)
    firestore.collection('memberRequest').where('treeID', '==', currentFamilyID)
        .get()
        .then((querySnapshot) => {
            const joinRequestList = document.getElementById('join-request-list');
            joinRequestList.innerHTML = ''; // Clear the list

            if (querySnapshot.empty) {
                // If there are no join requests, display a message
                const message = document.createElement('p');
                message.textContent = 'No join requests found.';
                joinRequestList.appendChild(message);
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>${data.firstName} ${data.lastName}</span>
                        <button onclick="acceptJoinRequest('${doc.id}', '${data.userID}')">Accept</button>
                        <button onclick="declineJoinRequest('${doc.id}')">Decline</button>
                    `;
                    joinRequestList.appendChild(listItem);
                });
            }
        })
        .catch((error) => {
            console.error('Error loading join requests:', error);
        });
}






        
function joinRequestFunc() {
    // Get input values
    const firstName = document.getElementById('request_first-name').value;
    const lastName = document.getElementById('request_last-name').value;
    const location = document.getElementById('request_location').value;
    const note = document.getElementById('request_note').value;

    // Validate input data if needed

    // Create an object to represent the join request data
    const joinRequestData = {
        firstName: firstName,
        lastName: lastName,
        location: location,
        treeID: requestFamilyID,
        userID: userID,
        note: note,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),

        // Add more fields as needed
    };

    // Add the join request to the Firestore collection
    firestore.collection('memberRequest').add(joinRequestData)
        .then((docRef) => {
            console.log('Join request added with ID:', docRef.id);
            // You can perform further actions or provide feedback to the user
            // Clear form fields if needed
newsPost(`${joinRequestData.firstName} ${joinRequestData.lastName} request to join Family Tree`);

            document.getElementById('request_first-name').value = '';
            document.getElementById('request_last-name').value = '';
            document.getElementById('request_location').value = '';
            document.getElementById('request_note').value = '';
        })
        .catch((error) => {
            console.error('Error adding join request:', error);
        });
}



        
function toggleJoinTree() {
    const joinFamilytreeSection = document.getElementById("join-familytree-section");
    const joinTreeSection = document.getElementById("join-tree-section");

    // Check if the Create Tree section is currently visible
    if (joinFamilytreeSection.classList.contains("hidden")) {
        // Hide the Create Tree section
        joinTreeSection.classList.add("hidden");
        // Show the Join Tree section
        joinFamilytreeSection.classList.remove("hidden");
    } else {
        // Hide the Join Tree section
        joinFamilytreeSection.classList.add("hidden");
        // Show the Create Tree section
        joinTreeSection.classList.remove("hidden");
    }
}


        
// Function to search for family tree names
function searchFamilyTrees() {
    const searchInput = document.getElementById("family-tree-search").value;

    // Perform a Firestore query to search for family trees by name
    firestore.collection("familyTrees")
        .where("name", "==", searchInput)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                // No matching family trees found
                showMainMessage("No matching family trees found.");
            } else {
                // Display the matching family trees (you can decide how to display them)
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("Family Tree Name:", data.name);
                    console.log("Family Tree Location:", data.location);

                    requestFamilyID = data.treeID;
                    // Display more information as needed
    const join_tree_name = document.getElementById("join_tree_name");
    const join_tree_location = document.getElementById("join_tree_location");
 join_tree_name.innerHTML = data.name;                   
join_tree_location.innerHTML = data.location;

                });
                                    toggleJoinTree();

            }
        })
        .catch((error) => {
            console.error("Error searching for family trees:", error);
        });
}




        
// Function to get a family tree with the code
function getFamilyTreeWithCode() {
    const familyTreeCode = document.getElementById("family-tree-code").value;

    // Perform a Firestore query to get the family tree with the specified code
    firestore.collection("familyTrees")
        .where("familyCode", "==", familyTreeCode)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                // No family tree found with the specified code
                showMainMessage("No family tree found with the entered code.");
            } else {
                // Retrieve the family tree (assuming there is only one match)
                const familyTreeDoc = querySnapshot.docs[0];
                const familyTreeData = familyTreeDoc.data();
                    requestFamilyID = familyTreeData.treeID;

                // Use the family tree data as needed (e.g., display tree details)
                console.log("Family Tree Name:", familyTreeData.name);
                console.log("Family Tree Location:", familyTreeData.location);
                // Display more information as needed

   const join_tree_name = document.getElementById("join_tree_name");
    const join_tree_location = document.getElementById("join_tree_location");
 join_tree_name.innerHTML = familyTreeData.name;                   
join_tree_location.innerHTML = familyTreeData.location; 
                    toggleJoinTree();

    
            }
        })
        .catch((error) => {
            console.error("Error getting family tree with code:", error);
        });
}

// Add click event listeners to the search and enter code buttons
document.getElementById("search-button").addEventListener("click", searchFamilyTrees);
document.getElementById("enter-code-button").addEventListener("click", getFamilyTreeWithCode);

        // Function to toggle the visibility of Create Tree and Join Tree sections
function toggleTreeSections() {
    const createTreeSection = document.getElementById("create-tree-section");
    const joinTreeSection = document.getElementById("join-tree-section");
    const join_create_btn = document.getElementById("join-create-button");

    // Check if the Create Tree section is currently visible
    if (!createTreeSection.classList.contains("hidden")) {
        // Hide the Create Tree section
        createTreeSection.classList.add("hidden");
        // Show the Join Tree section
        joinTreeSection.classList.remove("hidden");
        join_create_btn.innerHTML= "Create Family Tree";
    } else {
        // Hide the Join Tree section
        joinTreeSection.classList.add("hidden");
        // Show the Create Tree section
        createTreeSection.classList.remove("hidden");
                join_create_btn.innerHTML= "Join Family Tree";

    }
}



// Function to display the add member modal
function showAddMemberModal() {
    const modal = document.getElementById('add-member-modal');
    modal.style.display = 'block';
}

// Function to close the add member modal
function closeAddMemberModal() {
    const modal = document.getElementById('add-member-modal');
    modal.style.display = 'none';
}

// Close the modal if the user clicks outside of it
window.onclick = function(event) {
    const modal = document.getElementById('add-member-modal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};

     // Function to open the pop-up
        function openPopup() {
            document.getElementById("popup-container").style.display = "flex";
        }

        // Function to close the pop-up
        function closePopup() {
            document.getElementById("popup-container").style.display = "none";
        }





	    






          var treeData = '';

        

async function getFamilyTreeData(treeId) {
    try {

            // Ensure userID is defined and not empty
    if (!treeId) {
        

          return;
    }
        // Reference to the Firestore collection
        const familyTreesCollection = firestore.collection('familyTrees');

        // Query the collection for the specific treeId
        const querySnapshot = await familyTreesCollection.where('treeID', '==', treeId).get();

        // Check if a document matching the query exists
        if (querySnapshot.empty) {
            console.log('No matching documents.');
            return null;
        }

        // Retrieve the data from the first matching document (assuming treeId is unique)
        const familyTreeData = querySnapshot.docs[0].data();
	    		    treeData = familyTreeData;

                        console.log('new Family tree familyTreeData:', familyTreeData);

        return familyTreeData;
    } catch (error) {
        console.error('Error getting family tree:', error);
        return null;
    }
}





        
async function getFamilyTree(userID) {
    // Ensure userID is defined and not empty
    if (!userID) {
        // console.error('UserID is not defined or empty.');
        return;
    }

    // Reference to the user document in Firestore
    const userDocRef = firestore.collection('users').doc(userID);

    try {
        const doc = await userDocRef.get();

        if (doc.exists) {
            // Check if the user document has a "userTrees" field (an array of family tree IDs)
            if (doc.data().userTrees && doc.data().userTrees.length > 0) {
                // Get the first family tree ID from the user's array of family tree IDs
                const familyTreeId = doc.data().userTrees[0]; // You can modify this to get the desired family tree ID
                console.log('User has a family tree with ID:', familyTreeId);
		    
currentFamilyID = familyTreeId;

    
		    
                const tree = await getFamilyTreeData(familyTreeId);
                     displayTreeDetails(tree);
		    treeData = tree;
		            setTimeout(() => {
                loadFamilyTreeChart(treeData);
            }, 300); // Adj
			const treeID = tree.treeID;
			//currentFamilyID =treeID;
                    displayFamilyMembers(treeID);
                return;
            } else {
                document.getElementById("tree-details").style.display = "none";
                document.getElementById("family-tree").style.display = "none";
                document.getElementById("family-news").style.display = "none";
                document.getElementById("member_Request").style.display = "none";
                console.log('User does not have any family trees.');
                openPopup();
            }
        } else {
            console.log('User document does not exist.');
           window.location.href = '/wefamily';
        }
    } catch (error) {
        console.error('Error getting user document:', error);
    }
}

var userID;
	    
async function fetchFamilyTree() {
    try {
        const userId = await checkUserLogin();
userID = userId;
        if (userID) {
// Get the logo link element by its ID
const logoLink = document.getElementById('logo-link');
// Set the href attribute dynamically with the userId
logoLink.href = `/wefamily/dashboard/?user=${userID}`;

	
            const treeId = getTreeIdFromQueryParams();

            if (treeId) {
                const tree = await getFamilyTreeData(treeId);

                if (tree) {
                   displayTreeDetails(tree);
			const treeID = tree.treeID;
			currentFamilyID = treeID;
                    displayFamilyMembers(treeID);

                } else {
                    console.log('Family tree not found.');
                    // Handle the case when the family tree is not found.
                            getFamilyTree(userID);
                }
            } else {
                console.log('Missing treeId parameter.');
                // Handle the case when the treeId query parameter is missing.
                            getFamilyTree(userID);
            }
        } else {
            // Redirect to the login page if the user is not logged in.
            console.log('checking user login:');

           window.location.href = '/wefamily';

        }
    } catch (error) {
        console.error('Error checking user login:', error);
        // Handle errors here, e.g., display an error message to the user.
    }
}


// JavaScript:


        // Function to add a new family member


function isFirstChild(currentFamilyID) {
    const db = firebase.firestore();
	                    console.log(' currentFamilyID.',currentFamilyID);

    // Query Firestore to count the documents
    return db.collection("familyMembers")
        .where('familyID', 'array-contains', currentFamilyID)
        .get()
        .then((querySnapshot) => {
            const count = querySnapshot.size; // Get the count of documents

            // Check if it's the first family member (count is 0)
            if (count === 0) {

	                    console.log(' first family member.');

                return true;
            } else {
                return false;
            }
        })
        .catch((error) => {
            console.error(`Error counting family members: ${error}`);
            throw error; // You can handle the error as needed
        });
}

	    function checkFirstMember(currentFamilyID, memberID){
isFirstChild(currentFamilyID)
    .then((isFirst) => {
        if (isFirst) {
            console.log("This is the first family member.");
            // Perform actions for the first family member here
			                    console.log('setRootValue memberID.',memberID);
claimMemberFunc(memberID);

setRootValue(memberID);
	    
        } else {
            console.log("This is not the first family member.");
            // Perform actions for non-first family members here
        }
    })
    .catch((error) => {
        console.error(`Error checking if it's the first family member: ${error}`);
    });
	    }


        
    
        // Function to get the treeId from query parameters
        function getTreeIdFromQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("tree");
        }
var Current_USERNAME = '';
var Current_USERPHOTO = '';
        // Function to display tree details
        function displayTreeDetails(tree) {
            document.getElementById("tree-name").value = tree.name;
            document.getElementById("tree-location").value = tree.location;
            document.getElementById("tree-description").value = tree.description;

        }

        // Function to display family members
  async function displayFamilyMembers(treeID) {
	  		loadPosts();
if(!treeID){
		return;
	}
    const familyMembersContainer = document.getElementById("family-members");
    familyMembersContainer.innerHTML = ""; // Clear existing members

    const familyMembersCollection = firestore.collection('familyMembers');

    try {
const querySnapshot = await familyMembersCollection.where('familyID', 'array-contains', treeID).get();
if(querySnapshot.length === 0){ 
                document.getElementById("tree-details").style.display = "none";
                document.getElementById("family-tree").style.display = "none";
                document.getElementById("family-news").style.display = "none";
                document.getElementById("member_Request").style.display = "none";
}else{
                document.getElementById("tree-details").style.display = "block";
                document.getElementById("family-tree").style.display = "block";
                document.getElementById("family-news").style.display = "block";
                document.getElementById("member_Request").style.display = "block";
}
if (querySnapshot.size > 0) {
document.getElementById("add-member").style.display = "none";

	    }
	//console.log('querySnapshot.size  ID:', querySnapshot.size );
document.getElementById("familyCount").innerHTML = querySnapshot.size+" Members";
	    
        querySnapshot.forEach((member) => {
            const data = member.data();
            // Implement dynamic population of family member details here
let claim_Div = "";		
if (data.memberID === userID || data.addByID === userID) {
 Current_USERNAME = data.first_name;
 Current_USERPHOTO = data.photo;
claim_Div = "<button class='edit-member'>Edit Member</button>";
}else{
if(data.userID === "" ){
claim_Div = "<button class='claim-member'>Claim Member</button>";
}
	
}
	                //console.log('userID ID:', userID);
	                //console.log('data.userID ID:', data.userID);
	
            const memberDiv = document.createElement("div");
        memberDiv.className = 'family-member';
            memberDiv.innerHTML = `
 <button class="add-parent">Add Parent</button>
            <div id="${data.memberID}" class="member-details">
                <!-- Member details go here -->
               <p>Name: ${data.first_name} ${data.last_name}</p>
                <p>Birthdate: ${data.birthdate}</p>
            ${claim_Div}
                <!-- Add other fields as needed -->
  
            </div>
            <button class="add-spouse">Add Spouse</button>
            <button class="add-child">Add Child</button>
            <button class="add-sibling">Add Sibling</button>
        `;

        // Add event listeners for each button in the new family member
   const addParentBtn = memberDiv.querySelector('.add-parent');
addParentBtn.addEventListener('click', () => addParent(data));


const addChildBtn = memberDiv.querySelector('.add-child');
addChildBtn.addEventListener('click', () => addChild(data));



		

if (data.memberID === userID || data.addByID === userID) {
    const editMemberBTN = memberDiv.querySelector('.edit-member');
    editMemberBTN.addEventListener('click', () => editMemberFunc(data));
} else {
    if (data.userID === "") {
        const claimMemberBTN = memberDiv.querySelector('.claim-member');
        claimMemberBTN.addEventListener('click', () => claimMemberFunc(data));
    }
}

    
            familyMembersContainer.appendChild(memberDiv);

		initializeFamilyTreeChart();
        });
    } catch (error) {
        console.error('Error displaying family members:', error);
    }
}

	    function claimMemberFunc(member){
//showMainMessage("claim "+member.memberID);

let memberID = member.memberID;
            const userDocRef = firestore.collection('familyMembers').doc(memberID);

                        // Update the user document to add the family tree ID to the "userTrees" array field
                        userDocRef.update({
                            userID: firebase.firestore.FieldValue.arrayUnion(userID)
                        })
                            .then(() => {
                                console.log('Family tree ID added to user document successfully.');
			newsPost(`Admin ID ${memberID} created ${member.name} on ${member.timestamp} `);
               // loadFamilyTreeChart(treeData);
                fetchFamilyTree();

                            })
                            .catch((error) => {
                                console.error('Error adding family tree ID to user document:', error);
                            });



	    
	newsPost(`${userID} claimed ${member.first_name} ${member.last_name} `);

	    }	    
	



	    

	    var addFamily_Type = '';
	    var addFamily_MemberID = '';
	    var addFamily_MemberData = '';

	function showAddMemberTypePopup(xxx) {
	document.getElementById('memberType').innerHTML = "Add Member " + xxx;    
	document.getElementById('memberTypeBTN').innerHTML = "Add Member "+ xxx;
		
		const modal = document.getElementById('add-member-type');
    modal.style.display = 'block';
}

// Function to close the add member modal
function closeAddMemberTypePopup() {
	document.getElementById('memberType').innerHTML = "";    
	document.getElementById('memberTypeBTN').innerHTML = "";  
	
	const modal = document.getElementById('add-member-type');
    modal.style.display = 'none';
	addFamily_Type = '';
	    addFamily_MemberID = '';
	addFamily_MemberData = '';

}

// Close the modal if the user clicks outside of it
window.onclick = function(event) {
    const modal = document.getElementById('add-member-type');
    if (event.target === modal) {
        modal.style.display = 'none';
	document.getElementById('memberType').innerHTML = "";    
	document.getElementById('memberTypeBTN').innerHTML = "";  
	    addFamily_Type = '';
	    addFamily_MemberID = '';
	    addFamily_MemberData = '';

    }
};


//  addChildToParent(newID, addFamily_MemberID);  Parent
// addSpouse(newID, addFamily_MemberID); Spouse
// addSiblings(newID, addFamily_MemberID);  Sibling
// addParentTChild(newID, addFamily_MemberID); Child
	    


        // Call the fetchFamilyTree function on page load
        window.onload = fetchFamilyTree;

 



	
    </script>

    <script defer src="family-tree-script.js"></script>
    <script defer src="add_edit_family_tree_funcs.js"></script>
    <script defer src="post_funcs.js"></script>
    <script defer src="add_edit_members_funcs.js"></script>

	</body>
  <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2023 WeFamily. All rights reserved.<a id="LRP" href='https://rw-501.github.io/Portfolio/'>Dev Portfolio</a> </p>
		<p>update v1.92</p>
        </div>
    </footer>

	
</html>
