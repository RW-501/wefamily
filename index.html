<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">

  <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script src="auth.js"></script>
    <script src="firebase.js"></script>
    <title>Family Tree App</title>
 <style>
/* Reset some default styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

progress {
    background-color: #898989;
    width: 40%;
    margin: auto;
    color: #979797;

}
select	 input[type="text" i]  input[type="date" i] {
  font-size: 1.5em;
}

	 
	 #progressBar{

		     margin: auto;
    width: 100%;
    display: flex;
    justify-content: space-between;
	 }
.view{
    margin: auto;
    width: 80%;
display:none;
}
	 #welcomeDiv{
     z-index: 10;
    width: 100%;
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    margin: auto;
    height: fit-content;
    min-height: 600px;
}
	 #view1 .image-container{
border-radius: 0;
	 }

	 
	 .hidden{
		 display:none;
	 }
.logo{
	    list-style: none;
}
	 .logo h1{
	            color: #fff;
	}
	 .logo a{
    text-decoration: none;
    color: #fff;
    font-size: 2em;
    font-weight: 700;
}
	#LRP{
    text-decoration: none;
    color: #858585;
    font-weight: 600;
    font-size: 1.5em;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    display: block;
    margin: 1%;

}
/* Apply basic styles to the header and navigation */
header {
    background-color: #222;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
}

.logo h1 {
    font-size: 2rem;
}

nav ul {
    list-style: none;
    text-align: center;
}

nav ul li {
    display: inline;
    margin: 0 1rem;
}

nav ul li a {
    text-decoration: none;
    color: #fff;
    font-weight: bold;
}
/* Reset some default styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

	  .mainMessage-box {
  position: fixed;
  top: -100px; /* Initially hidden above the viewport */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
    color: #fff;
    font-weight: 800;
	width: 300px;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
  transition: top 0.5s ease-in-out;
  z-index: 1000;
}

.mainMessage-content {
  display: flex;
  flex-direction: column;
  align-items: center;
text-align: center;
}

#mainMessageText {
  margin: 10px 0;
    color: #fff;
}

/* Styling for the close button */
#mainCloseButton {
    background-color: #7b7978;
    color: #fff;
    border: none;
    border-radius: 3px;
    padding: 5px 10px;
    cursor: pointer;
    font-weight: 600;

}

#mainCloseButton:hover {
  background-color: #575453;
}



main {
    padding: 2rem;
    min-height: 700px;
}
              #photo-area {
            background-image: url('images/pics.png'); /* Replace with your image path */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            height: 100vh; /* Adjust the height as needed */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: -1; /* Place it behind other content */
        }
        /* Add your CSS styles here */
      #mainContainer{
    display: block;
    width: 100%;
	min-height: 700px;  
      }
	       #mainContainer

        .container {
        position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    top: 0;
    z-index: 2;
    margin: auto;
    height: fit-content;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            text-align: center;
            color: #333;
        }

        #auth-container {
            margin-top: 20px;
        }

        .tab-button {
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #login-form, #register-form, #phone-form{
            display: none;
        }

        .active-tab {
            display: block;
        }

        input[type="tel"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
    box-sizing: border-box;
        }

        button {
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
      #tab-container{
     display: flex;
    cursor: pointer;
    width: 100%;
    justify-content: center;
    background-color: black;

      }
 /* Apply styles to the footer */
	.footer {
    background-color: #222;
    color: #fff;
    text-align: center;
    padding: 1rem 0;
}

	footer {
    background-color: #222;
    color: #fff;
    text-align: center;
    padding: 1rem 0;
}
      .grid{
display:grid;
      }

	 .grid button{
		     margin: 2%;
	 }


.views{
	display:none;
}
	
	.image-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            background-color: lightgray;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
		    margin: auto;
        }

        .uploaded-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input {
            display: none; /* Hide the file input */
        }



	 
    </style>
</head>
<body>
    <header>
        <div class="logo">
                <li><a href="/wefamily/"><h1>WeFamily</h1></a></li>
        </div>
        <nav>
            <ul>
                <li><a href="/wefamily/about">About</a></li>
                <li><a href="/wefamily/contact">Contact</a></li>
            </ul>
        </nav>
    </header>
 <!-- Photo area filler -->
    <div id="photo-area"></div>
            <div id="mainContainer" > <div class="container">

        <h1>Welcome to WeFamily</h1>
        <div id="auth-container">
        <div id="tab-container">
            <button class="tab-button" onclick="toggleTab('login')">Login</button>
            <button class="tab-button" onclick="toggleTab('register')">Register</button>
<!-- Add a new button for Phone Authentication -->
<button class="tab-button hidden" onclick="toggleTab('phone')">Login with Phone</button>
        </div>
            <div id="login-form" class="active-tab">
          <h3>Login</h3>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
		    <div class="grid">
                <button onclick="loginWithEmailPassword()">Login</button>
                <button id="googleLogin" onclick="loginWithGoogle()">Login With Google</button>
		    
                <button class="hidden" onclick="loginAnonymously()">Login Anonymously</button>
		    </div>
            </div>

<!-- Create a new form for phone authentication -->
<div class="hidden" id="phone-form">
    <h3>Login with Phone</h3>
    <input type="tel" id="phone-number" placeholder="Phone Number" required>
    <button onclick="loginWithPhoneAuthentication()">Send Verification Code</button>
</div>
            
            <div id="register-form">
                <h3>Register</h3>
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button onclick="register()">Register</button> 

            </div>
        </div>
    </div>
    </div>

  <div id="welcomeDiv" class="container">
    <div id="progressBar">
      <button onclick="prevView()">Previous</button>
      <progress id="progress" value="0" max="3"></progress>
      <button onclick="nextView()">Next</button>
    </div>

   <div id="views">
      <div id="view1" class="view">
        <h2>Personalize Your Profile</h2>
        <p>Add a personal touch to your profile by uploading a profile picture and setting a unique username. Make your presence on our platform uniquely you.</p>

	      		 <!-- Image container with onclick event -->
    <div class="image-container" onclick="openFileInput(this)">
        <!-- Display uploaded image here -->
        <img class="uploaded-image" src="/wefamily/images/imgPlacehoder.png" alt="Uploaded Image">
        <!-- File input element -->
        <input id="profilePicInput" type="file" name="image" accept="image/*" class="file-input" onchange="handleFileUpload(this)">
    </div>
	      
	      
        <input type="text" id="username" placeholder="Enter your username">
        <button onclick="skip()">Next</button>
      </div>

      <div id="view2" class="view">
        <h2>Celebrate Special Moments</h2>
        <p>Share your birthday with us, and let's celebrate the milestones of your life. We believe in commemorating each day that made you who you are.</p>
        <input type="date" id="birthday">
        <button onclick="skip()">Skip</button>
      </div>

      <div id="view3" class="view">
        <h2>Connect Locally and Globally</h2>
        <p>Tell us where you are! Connect with fellow users near you or from distant places. Our community spans the globe, and we'd love for you to be a part of it.</p>
        <input type="text" id="city" placeholder="City">
        <input type="text" id="state" placeholder="State">

	<select id="countryDropdown">
  <option value="US" selected>United States</option>
  <option value="CA">Canada</option>
  <option value="AU">Australia</option>
  <option value="GB">United Kingdom</option>
  <option value="DE">Germany</option>
  <option value="FR">France</option>
  <option value="JP">Japan</option>
  <option value="IT">Italy</option>
  <option value="ES">Spain</option>
  <option value="BR">Brazil</option>
  <option value="IN">India</option>
  <option value="CN">China</option>
  <option value="KR">South Korea</option>
  <option value="MX">Mexico</option>
  <option value="RU">Russia</option>
  <option value="ZA">South Africa</option>
  <option value="AR">Argentina</option>
  <option value="NZ">New Zealand</option>
  <option value="NL">Netherlands</option>
  <option value="SE">Sweden</option>
  <!-- Add more country options here -->
</select>


	      
        <button onclick=" updateUserProfile(userId)">Skip</button>
      </div>

   </div>
  </div>

</body>

	
    <div class="mainMessage-box" id="mainMessageBox">
  <div class="mainMessage-content">
    <p id="mainMessageText">Your message here</p>
    <button id="mainCloseButton">Close</button>
  </div>
</div>
    <script>





let currentView = 1;

function nextView() {
  if (currentView < 3) {
    currentView++;
    updateView();
  }
}

function prevView() {
  if (currentView > 1) {
    currentView--;
    updateView();
  }
}

function skip() {
  if (currentView < 3) {
    currentView++;
    updateView();
  }
}

function updateView() {
  const views = document.querySelectorAll('.view');
  views.forEach(view => view.style.display = 'none');
  document.getElementById(`view${currentView}`).style.display = 'block';

  // Update progress bar
  const progressBar = document.getElementById('progress');
  progressBar.value = currentView - 1;
}


async function updateUserProfile(userId) {

  const countryDropdown = document.getElementById('country-dropdown');
  const selectedCountry = countryDropdown.value;

  const username = document.getElementById('username').value;
  const birthday = document.getElementById('birthday').value;
  const city = document.getElementById('city').value;
  const state = document.getElementById('state').value;

  // Use the retrieved values as needed
  console.log('Selected Country:', selectedCountry);
  console.log('Username:', username);
  console.log('Birthday:', birthday);
  console.log('City:', city);
  console.log('State:', state);

if(!username){
showMainMessage("Username is blank");
	ruturn;
}
if(!state){
showMainMessage("State is blank");
	ruturn;
}
	    
const selectedFile = document.getElementById('profilePicInput').files[0]; 
					     // Get the selected file

if(!selectedFile){
         // Update the family tree document with the photo URL
                                          try {
         firestore.collection('users').doc(userId).update({
            userName: username,
            state: state,
            city: city,
            country: selectedCountry,
            userID: userID
        });
        console.log('User profile updated successfully.');
        return true;
    } catch (error) {
        console.error('Error updating user profile:', error);
        return false;
    }
}else{
					     
                        const storagePath = 'profilePicInput'; // Change the storage path as needed
                        uploadImageToStorage(
                            selectedFile,
                            storagePath,
                            (downloadURL) => {
                                console.log('Image uploaded successfully:', downloadURL);
                                // Handle success, e.g., save the downloadURL to your database

                                try {
         firestore.collection('users').doc(userId).update({
               userName: username,
            photo: downloadURL,
            state: state,
            city: city,
            country: selectedCountry,
            userID: userID
	});
        console.log('User profile updated successfully.');
        return true;
    } catch (error) {
        console.error('Error updating user profile:', error);
        return false;
    }
                                })
                                .then(() => {
                                    console.log('Photo URL added to family tree document.');

                                })
                                .catch((error) => {
                                    console.error('Error adding photo URL to family tree document:', error);
                                });

	

}

}

	    

	    
//showMainMessage("message");
// Function to open the file input dialog when the image container is clicked
function openFileInput(container) {
    container.querySelector('.file-input').click();
}

// Function to handle file upload and display the selected image
function handleFileUpload(input) {
    const file = input.files[0];

    if (file) {
        // Check file type and size here (you can use the uploadImageToStorage function from earlier)
        // For simplicity, we'll just display the selected image
        const uploadedImage = input.previousElementSibling;
        uploadedImage.src = URL.createObjectURL(file);
    }
}

	    
// Reusable function to upload an image to Firebase Storage
function uploadImageToStorage(file, storagePath, successCallback, errorCallback) {
  // Check if a file was selected
  if (!file) {
    if (errorCallback) errorCallback('Please select an image file.');
    return;
  }

  // Check file type (allow only images)
  if (!file.type.startsWith('image/')) {
    if (errorCallback) errorCallback('Please select an image file (e.g., JPEG or PNG).');
    return;
  }

  // Check file size (limit to 5MB)
  if (file.size > 5 * 1024 * 1024) {
    if (errorCallback) errorCallback('Image size must be less than 5MB.');
    return;
  }

  // Create a reference to Firebase Storage
  const storageRef = firebase.storage().ref();

  // Generate a unique filename for the image
  const timestamp = Date.now();
  const filename = `${timestamp}_${file.name}`;

  // Create a reference to the storage location
  const imageRef = storageRef.child(`${storagePath}/${filename}`);

  // Resize the image to 500x500 pixels (using a library like HTMLCanvasElement)
  const img = new Image();
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  img.onload = () => {

	  
// Max width or height for the image
const maxSize = 500;

// Calculate new dimensions while maintaining aspect ratio
let newWidth, newHeight;
if (img.width > img.height) {
  newWidth = maxSize;
  newHeight = (img.height / img.width) * maxSize;
} else {
  newHeight = maxSize;
  newWidth = (img.width / img.height) * maxSize;
}


// Resize the image using canvas
canvas.width = newWidth;
canvas.height = newHeight;
ctx.drawImage(img, 0, 0, newWidth, newHeight);


    // Convert the resized image to a Blob
    canvas.toBlob((blob) => {
      // Upload the Blob to Firebase Storage
      const uploadTask = imageRef.put(blob);

      // Monitor the upload progress
      uploadTask.on(
        'state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log(`Upload progress: ${progress}%`);
        },
        (error) => {
          console.error('Upload error:', error);
          if (errorCallback) errorCallback('Image upload failed.');
        },
        () => {
          // Upload completed successfully, get the download URL
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            console.log('Image URL:', downloadURL);
            if (successCallback) successCallback(downloadURL);
          });
        }
      );
    }, 'image/jpeg', 0.9); // Convert to JPEG with 90% quality
  };

  // Load the selected image
  img.src = URL.createObjectURL(file);
}




	    
	    
        // JavaScript functions for login and registration
function toggleTab(tabName) {
    // Hide all forms
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('phone-form').style.display = 'none';

    // Show the selected tab
    document.getElementById(tabName + '-form').style.display = 'block';
}

        
        // JavaScript functions for login and registration

async function loginWithEmailPassword() {
    try {
        // Get input values
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        // Sign in the user
        const userCredential = await auth.signInWithEmailAndPassword(email, password);

        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Get the user's ID
        const userId = userCredential.user.uid;

        // Reference to the user document in Firestore
        const userDocRef = firestore.collection('users').doc(userId);

        // Get the current login count
        let loginCount = 0;

        // Fetch the user document to get the current login count
        const userDoc = await userDocRef.get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            loginCount = userData.loginCount || 0;
        }else{
 showMainMessage('No User, Please Register');
        }

        // Update the login count in Firestore
        await userDocRef.update({
            loginCount: loginCount + 1,
        });

        // Redirect to the dashboard with user ID as a query parameter
        window.location.href = `dashboard/?user=${userId}`;

        return true;
    } catch (error) {
        console.error('Login failed:', error.message);
        return false;
    }
}


const currentDate = new Date();

// Function to log in with phone (Note: Implement Firebase phone login pop-up)
 async function loginWithPhoneAuthentication() {
    try {
        // Get the user's phone number from the input field
        const phoneNumber = document.getElementById('phone-number').value;

        // Validate the phone number (you can add more validation if needed)
        if (!phoneNumber || !/^\+\d{10,}$/g.test(phoneNumber)) {
            showMainMessage('Please enter a valid phone number in the format: +1234567890');
            return;
        }

        // Create a Recaptcha verifier for phone number verification
        const recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            size: 'invisible',
        });

        // Send the verification code to the user's phone
        const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, recaptcha);

        // Implement UI to allow the user to enter the code and confirm their phone number
        const verificationCode = prompt('Enter the verification code sent to your phone:');
        const userCredential = await confirmationResult.confirm(verificationCode);

        // Phone number authentication successful, you can now save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Create a user document in Firestore (if needed)
        const user = userCredential.user;
        const userId = user.uid;
        await firestore.collection('users').doc(userId).set({
            phoneNumber: user.phoneNumber,
                userName: "Family Member", 
                loginCount: 1, // Initialize login count to 1
                email: "",
            userTrees: [],
            signUpType:"Phone",
            signUpDate:  firebase.firestore.FieldValue.serverTimestamp(), // Add a timestamp,
		birthday: '',
		photo: photoURL,
		state:'',
		city:'',
		country:"USA",
            
            // Add more user-related data here
        });

        // Redirect to the dashboard with user ID as a query parameter
        window.location.href = `dashboard/?user=${userId}`;
    } catch (error) {
        console.error('Phone login failed:', error.message);
    }
}



// Function to log in anonymously
async function loginAnonymously() {
    try {
        // Attempt to sign in anonymously
        const userCredential = await auth.signInAnonymously();
        
        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');
        
        // Get the user's unique ID
        const userId = userCredential.user.uid;
        
        // Check if the user document exists in Firestore
        const userDoc = await firestore.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            // User document exists, update the login count
            await firestore.collection('users').doc(userId).update({
                loginCount: firebase.firestore.FieldValue.increment(1)
            });
        } else {
            // User document doesn't exist, create a new user document
            await firestore.collection('users').doc(userId).set({
                userName: "Anonymous", 
                loginCount: 1, // Initialize login count to 1
                email: "",
            userTrees: [],
            signUpType:"Anonymous",
            phoneNumber: "",
            signUpDate: currentDate,

                // Add more user-related data here
            });
        }
        
        // Redirect to the dashboard with user ID as a query parameter
        window.location.href = `dashboard/?user=${userId}`;
        
        return true;
    } catch (error) {
        console.error('Anonymous login failed:', error.message);
        return false;
    }
}


// Function to register a new user with email and password
async function register() {
    try {
        // Get input values
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        // Create a new user in Firebase Authentication
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);

        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Create a user document in Firestore with the user's UID
        await firestore.collection('users').doc(userCredential.user.uid).set({
                userName: "Family Member", 
                loginCount: 1, // Initialize login count to 1
                email: email,
            userTrees: [],
            signUpType:"Email",
            phoneNumber: "",
                 signUpDate:  firebase.firestore.FieldValue.serverTimestamp(), // Add a timestamp,
		birthday: '',
		photo: photoURL,
		state:'',
		city:'',
		country:"USA",
			// Add more user-related data here
        });

        // Redirect to the dashboard page with user ID as a query parameter
        window.location.href = `dashboard/?user=${userCredential.user.uid}`;

        return true;
    } catch (error) {
        console.error('Registration failed:', error.message);
        return false;
    }
}

function checkLoggedInAndRedirect() {
    const userLoggedIn = localStorage.getItem('userLoggedIn');
    
    if (userLoggedIn === 'true') {
        const auth = firebase.auth();

        const unsubscribe = auth.onAuthStateChanged((user) => {
            unsubscribe(); // Unsubscribe to avoid memory leaks

            if (user) {
                // User is logged in
                const userId = user.uid;
                console.log('User is logged in with UID:', userId);
                window.location.href = `dashboard/?user=${userId}`;
            } else {
                // User is logged out
                console.error('No user is signed in');
            }
        });
    }
}

	    async function loginWithGoogle() {
    try {
        // Use Firebase Google Sign-In provider
        const provider = new firebase.auth.GoogleAuthProvider();

        // Sign in with Google
        const userCredential = await firebase.auth().signInWithPopup(provider);

        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Get the user's ID
        const userId = userCredential.user.uid;
        const user = userCredential.user;
        const displayName = user.displayName;
        const photoURL = user.photoURL;
        const email = user.email;

        // Reference to the user document in Firestore
        const userDocRef = firestore.collection('users').doc(userId);

        // Get the current login count
        let loginCount = 0;

        // Fetch the user document to get the current login count
        const userDoc = await userDocRef.get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            loginCount = userData.loginCount || 0;
        } else {


        // Create a user document in Firestore with the user's UID
        await firestore.collection('users').doc(userCredential.user.uid).set({
                userName: displayName, 
                loginCount: 1, // Initialize login count to 1
                email: email,
            userTrees: [],
            signUpType:"Google",
            phoneNumber: "",
            signUpDate:  firebase.firestore.FieldValue.serverTimestamp(), // Add a timestamp,
		birthday: '',
		photo: photoURL,
		state:'',
		city:'',
		country:"USA",
            // Add more user-related data here
        });
		const imgElement = document.getElementById(photoURL);

imgElement.src = imageUrl;
	
	}

        // Update the login count in Firestore
        await userDocRef.update({
            loginCount: loginCount + 1,
        });

        // Redirect to the dashboard with user ID as a query parameter
        window.location.href = `dashboard/?user=${userId}`;

        return true;
    } catch (error) {
        console.error('Login with Google failed:', error.message);
        return false;
    }
}


// Call the function to check and redirect
checkLoggedInAndRedirect();

toggleTab('login');
	    
    </script>
      <!-- Footer -->
    <footer class="footer">
        <div class="">
            <p>&copy; 2023 WeFamily. All rights reserved.<a id="LRP" href='https://rw-501.github.io/Portfolio/'>Dev Portfolio</a> </p>
        </div>
    </footer>

</html>
